const bgList = [
  "assets/img/background/close-up-white-flowering-plant-against-wall.jpg",
  "assets/img/background/still-life-minimalist-lifestyle.jpg",
  "assets/img/background/white-rose-blooming-against-wall.jpg",
  "assets/img/background/view-rose-flowers-condensed-glass.jpg",
  "assets/img/background/modern-minimalist-living-room.jpg"
];

// Í∞úÎ∞ú Ï§ë Ìè¨Ïù∏Ìä∏ Î¶¨ÏÖã (Ï£ºÏÑù Ìï¥Ï†úÌïòÏó¨ ÏÇ¨Ïö©)
// localStorage.removeItem('points');

let currentIndex = 0;
let points = parseInt(localStorage.getItem('points')) || 0;
let questions = [];
let usedQuestions = new Set(); // ÌíÄÏóàÎçò Î¨∏Ï†úÎì§ÏùÑ Í∏∞Î°ùÌï† Set
let allQuestions = []; // Ï†ÑÏ≤¥ Î¨∏Ï†ú ÌíÄÏùÑ Ï†ÄÏû•Ìï† Î∞∞Ïó¥
let timer;
let timeLeft = 15;
let isAnswering = false;
let startTime;
let correctAnswers = 0;

// Ìö®Í≥ºÏùå Ï¥àÍ∏∞Ìôî
const soundClick = new Audio('assets/sounds/click.mp3');
const soundCorrect = new Audio('assets/sounds/correct.mp3');
const soundWrong = new Audio('assets/sounds/wrong.mp3');

// ÏÇ¨Ïö©Ïûê ÏÉÅÌò∏ÏûëÏö© ÌõÑ Ìö®Í≥ºÏùå ÌôúÏÑ±Ìôî
document.body.addEventListener('click', () => {
  soundClick.play().catch(() => {}); // Î≥¥Ïïà Ï†ïÏ±Ö Ïö∞Ìöå
}, { once: true });

// ÏùëÏõê Î©îÏãúÏßÄ Î™©Î°ù
const feedbackTexts = {
  correct: [
    "Ï†ïÎãµÏù¥ÏóêÏöî! +15Ï†ê Ï†ÅÎ¶Ω üéØ",
    "Ï¢ãÏùÄ ÏÑ†ÌÉùÏù¥ÏóêÏöî! Í±¥Í∞ï ÏßÄÏãùÏù¥ ÏåìÏó¨Í∞ÄÏöî ‚ú®",
    "ÏôÑÎ≤ΩÌï¥Ïöî! Ïò§ÎäòÎèÑ Í±¥Í∞ïÌïú ÏÑ†ÌÉù üíö",
    "Ï†ïÎãµÏûÖÎãàÎã§! Í±¥Í∞ï Î£®Ìã¥Ïù¥ ÎßåÎì§Ïñ¥ÏßÄÍ≥† ÏûàÏñ¥Ïöî üå±"
  ],
  wrong: [
    "Ï°∞Í∏à ÏïÑÏâΩÏßÄÎßå Í¥úÏ∞ÆÏïÑÏöî! -5Ï†ê üòÖ Îã§ÏùåÏóî Íº≠ ÎßûÌûê Ïàò ÏûàÏñ¥Ïöî",
    "ÌãÄÎ†∏ÏßÄÎßå Î∞∞Ïö∞Îäî Í≥ºÏ†ïÏù¥ÏóêÏöî! Ìï®Íªò ÏÑ±Ïû•Ìï¥Ïöî üí™",
    "ÏïÑÏâΩÎÑ§Ïöî, ÌïòÏßÄÎßå ÎèÑÏ†ÑÌïòÎäî ÎãπÏã†Ïù¥ Î©ãÏ†∏Ïöî ‚ú®",
    "Í¥úÏ∞ÆÏïÑÏöî, ÌãÄÎ¶∞ Î¨∏Ï†úÎäî Îçî Ïò§Îûò Í∏∞ÏñµÎêúÎãµÎãàÎã§ üí°"
  ]
};

document.addEventListener("DOMContentLoaded", () => {
  // Ïπ¥Ïπ¥Ïò§ÌÜ° Í≥µÏú† Î≤ÑÌäº Ï¥àÍ∏∞Ìôî
  if (window.Kakao) {
    Kakao.Link.createDefaultButton({
      container: '#kakao-share-btn',
      objectType: 'feed',
      content: {
        title: 'ÎäòÎ¥Ñ Í±¥Í∞ï ÌÄ¥Ï¶à',
        description: 'ÎÇòÎ•º ÏúÑÌïú ÏûëÏùÄ ÏäµÍ¥ÄÏùò Î≥ÄÌôî, ÎäòÎ¥ÑÍ≥º Ìï®Íªò Í±¥Í∞ïÌïú ÏäµÍ¥ÄÏùÑ ÎßåÎì§Ïñ¥Î≥¥ÏÑ∏Ïöî!',
        imageUrl: 'http://localhost:8000/assets/img/share-preview.jpg',
        link: {
          mobileWebUrl: 'http://localhost:8000',
          webUrl: 'http://localhost:8000',
        },
      },
      buttons: [
        {
          title: 'ÌÄ¥Ï¶à ÌíÄÎü¨Í∞ÄÍ∏∞',
          link: {
            mobileWebUrl: 'http://localhost:8000',
            webUrl: 'http://localhost:8000',
          },
        },
      ],
      success: function(response) {
        addPoints(200);
        showToast('Í≥µÏú† Í∞êÏÇ¨Ìï©ÎãàÎã§! +200PÍ∞Ä Ï†ÅÎ¶ΩÎêòÏóàÏñ¥Ïöî üíö');
      },
      fail: function(error) {
        console.log('Ïπ¥Ïπ¥Ïò§ÌÜ° Í≥µÏú† Ïã§Ìå®:', error);
      }
    });
  }

  // ÌòÑÏû¨ ÌéòÏù¥ÏßÄÍ∞Ä quiz.htmlÏù∏ Í≤ΩÏö∞ÏóêÎßå ÌÄ¥Ï¶à Í¥ÄÎ†® ÏΩîÎìú Ïã§Ìñâ
  if (window.location.pathname.includes('quiz.html')) {
    // Î∞∞Í≤Ω Ïù¥ÎØ∏ÏßÄ ÎûúÎç§ Ï†ÅÏö©
    const selectedBg = bgList[Math.floor(Math.random() * bgList.length)];
    document.body.style.backgroundImage = `url('${selectedBg}')`;
    document.body.style.backgroundPosition = 'center';
    document.body.style.backgroundSize = 'cover';
    
    startTime = Date.now();
    showLoading(true);
    
    Promise.all([
      fetch("health_quiz_set_all.json").then(res => res.json()),
      fetch("quiz1.json").then(res => res.json()),
      fetch("quiz2.json").then(res => res.json()),
      fetch("quiz3.json").then(res => res.json())
    ])
    .then(([allList, quiz1List, quiz2List, quiz3List]) => {
      const merged = [...allList, ...quiz1List, ...quiz2List, ...quiz3List];
      const uniqueQuestions = Array.from(new Map(merged.map(q => [q.question, q])).values());
      allQuestions = uniqueQuestions.sort(() => Math.random() - 0.5);
      questions = allQuestions;
      showLoading(false);
      showQuestion();
      updatePoints();
      updateProgress();
    });
  }
});

function showLoading(show) {
  const loading = document.getElementById('loading');
  const quizContent = document.getElementById('quiz-box').children;
  
  loading.style.display = show ? 'block' : 'none';
  Array.from(quizContent).forEach(element => {
    if (element.id !== 'loading') {
      element.style.opacity = show ? '0.5' : '1';
    }
  });
}

function updateProgress() {
  const progressText = document.getElementById('progress-text');
  const progressFill = document.getElementById('progress-fill');
  const progress = ((currentIndex + 1) / questions.length) * 100;
  
  progressText.textContent = `${currentIndex + 1}/${questions.length}`;
  progressFill.style.width = `${progress}%`;
}

function showQuestion() {
  if (isAnswering) return;
  
  clearInterval(timer);
  timeLeft = 15;
  document.getElementById("timer-fill").style.width = "100%";

  const q = questions[currentIndex];
  if (!q) {
    finishQuiz();
    return;
  }

  // ÌòÑÏû¨ Î¨∏Ï†úÎ•º usedQuestionsÏóê Ï∂îÍ∞Ä
  usedQuestions.add(q.question);

  updateProgress();
  
  const quizBox = document.getElementById("quiz-box");
  
  document.getElementById("question").textContent = q.question;
  const answersList = document.getElementById("answers");
  answersList.innerHTML = "";
  document.getElementById("explanation").innerHTML = "";
  document.getElementById("explanation").classList.remove("show");

  const options = [q.correct, ...q.wrong].sort(() => Math.random() - 0.5);
  options.forEach(option => {
    const li = document.createElement("li");
    li.textContent = option;
    li.onclick = () => {
      if (isAnswering) return;
      handleAnswer(option, q);
    };
    answersList.appendChild(li);
  });

  quizBox.style.opacity = "1";

  timer = setInterval(() => {
    timeLeft--;
    document.getElementById("timer-fill").style.width = (timeLeft * 6.67) + "%";
    if (timeLeft <= 0) {
      clearInterval(timer);
      handleAnswer(null, q);
    }
  }, 1000);
}

function handleAnswer(selected, question) {
  if (isAnswering) return;
  isAnswering = true;
  clearInterval(timer);

  try {
    soundClick.play().catch(() => {});
  } catch (e) {}

  const popup = document.getElementById("explanation-popup");
  const popupEmoji = document.getElementById("popup-emoji");
  const popupResult = document.getElementById("popup-result");
  const popupExplanation = document.getElementById("popup-explanation");
  const popupPoints = document.getElementById("popup-points");
  
  const answers = document.querySelectorAll("#answers li");
  
  answers.forEach(li => {
    if (li.textContent === question.correct) {
      li.classList.add("correct");
    } else if (li.textContent === selected) {
      li.classList.add("wrong");
    }
    li.style.pointerEvents = "none";
  });

  if (selected === question.correct) {
    correctAnswers++;
    points += 15;
    if (points < 0) points = 0;
    localStorage.setItem("points", points);
    
    popupEmoji.textContent = "üéâ";
    popupResult.textContent = "Ï†ïÎãµÏù¥ÏóêÏöî!";
    popupExplanation.textContent = question.explanation;
    popupPoints.innerHTML = `
      <div class="point-change">+15P</div>
      <div class="total-points">ÌòÑÏû¨ Ï¥ù ${points}P</div>
    `;
    popupPoints.style.color = "#28a745";
    
    try {
      soundCorrect.play().catch(() => {});
    } catch (e) {}
  } else {
    points -= 5;
    if (points < 0) points = 0;
    localStorage.setItem("points", points);
    
    popupEmoji.textContent = "üí™";
    popupResult.textContent = "ÏïÑÏâΩÏßÄÎßå ÌãÄÎ†∏Ïñ¥Ïöî";
    popupExplanation.textContent = `Ï†ïÎãµ: ${question.correct}\n${question.explanation}`;
    popupPoints.innerHTML = `
      <div class="point-change">-5P</div>
      <div class="total-points">ÌòÑÏû¨ Ï¥ù ${points}P</div>
    `;
    popupPoints.style.color = "#dc3545";
    
    try {
      soundWrong.play().catch(() => {});
    } catch (e) {}
  }

  popup.classList.add("show");
  updatePoints();

  // 3Ï¥à ÌõÑ ÌåùÏóÖ Îã´Í≥† Îã§Ïùå Î¨∏Ï†úÎ°ú
  setTimeout(() => {
    popup.classList.remove("show");
    currentIndex++;
    isAnswering = false;
    showQuestion();
  }, 3000);
}

function updatePoints() {
  const pointsDisplay = document.getElementById("points");
  if (!pointsDisplay) return;  // points ÏöîÏÜåÍ∞Ä ÏóÜÏúºÎ©¥ Ìï®Ïàò Ï¢ÖÎ£å
  
  const oldPoints = parseInt(pointsDisplay.textContent);
  const diff = points - oldPoints;
  
  if (diff > 0) {
    animatePoints(oldPoints, points, 1000);
  } else {
    pointsDisplay.textContent = points;
  }

  // ÌòÑÏû¨ ÌéòÏù¥ÏßÄÍ∞Ä quiz.htmlÏù∏ Í≤ΩÏö∞ÏóêÎßå exchange Î≤ÑÌäº ÏóÖÎç∞Ïù¥Ìä∏
  if (window.location.pathname.includes('quiz.html')) {
    const pointsAction = document.getElementById("points-action");
    const exchangeButton = document.getElementById("exchange-button");
    const pointsInsufficient = document.getElementById("points-insufficient");
    
    if (pointsAction) {
      pointsAction.style.display = "block";
      
      if (exchangeButton && pointsInsufficient) {
        if (points >= 5000) {
          exchangeButton.style.display = "block";
          pointsInsufficient.style.display = "none";
        } else {
          exchangeButton.style.display = "none";
          pointsInsufficient.style.display = "block";
        }
      }
    }
  }
}

function animatePoints(start, end, duration) {
  const pointsDisplay = document.getElementById("points");
  const startTime = performance.now();
  
  function update(currentTime) {
    const elapsed = currentTime - startTime;
    const progress = Math.min(elapsed / duration, 1);
    
    const currentPoints = Math.floor(start + (end - start) * progress);
    pointsDisplay.textContent = currentPoints;
    
    if (progress < 1) {
      requestAnimationFrame(update);
    }
  }
  
  requestAnimationFrame(update);
}

function finishQuiz() {
  const quizBox = document.getElementById('quiz-box');
  const quizComplete = document.getElementById('quiz-complete');
  const timeTaken = Math.floor((Date.now() - startTime) / 1000);
  const accuracy = Math.round((correctAnswers / currentIndex) * 100);
  
  document.getElementById('final-points').textContent = points;
  document.getElementById('accuracy').textContent = accuracy;
  document.getElementById('time-taken').textContent = timeTaken;
  
  // Í≥ÑÏÜçÌïòÍ∏∞ Î≤ÑÌäº Ï∂îÍ∞Ä
  quizComplete.innerHTML += `
    <div style="margin-top: 20px">
      <button onclick="continueQuiz()" class="primary-button">
        Í≥ÑÏÜçÌï¥ÏÑú ÌíÄÍ∏∞
      </button>
    </div>
  `;
  
  quizBox.style.display = 'none';
  quizComplete.style.display = 'block';
  
  // ÌôòÏ†Ñ Î≤ÑÌäº ÌëúÏãú Ï°∞Í±¥
  const exchangeBox = document.getElementById('exchange-box');
  if (points >= 5000) {
    exchangeBox.style.display = 'block';
    exchangeBox.innerHTML = `
      <div style="margin-bottom: 16px">
        üéâ Ï∂ïÌïòÌï©ÎãàÎã§! ${points}PÎ•º Î™®ÏúºÏÖ®ÎÑ§Ïöî!<br/>
        ÎäòÎ¥ÑÎ™∞ÏóêÏÑú Ï†ÅÎ¶ΩÍ∏àÏúºÎ°ú Ï†ÑÌôòÌïòÏã§ Ïàò ÏûàÏäµÎãàÎã§.
      </div>
      <button onclick="requestExchange()" class="primary-button">
        Ï†ÅÎ¶ΩÍ∏àÏúºÎ°ú Ï†ÑÌôòÌïòÍ∏∞
      </button>
    `;
  } else {
    exchangeBox.style.display = 'block';
    exchangeBox.innerHTML = `
      <div style="color: #666; margin: 16px 0">
        5,000P Ïù¥ÏÉÅÏù¥Î©¥ ÎäòÎ¥ÑÎ™∞ÏóêÏÑú Ï†ÅÎ¶ΩÍ∏àÏúºÎ°ú Î∞îÍøÄ Ïàò ÏûàÏñ¥Ïöî!<br/>
        (ÌòÑÏû¨ ${points}P / Î™©Ìëú 5,000P)
      </div>
    `;
  }
  
  // ÌÜµÍ≥Ñ Ïπ¥Îìú Ïï†ÎãàÎ©îÏù¥ÏÖò
  const statCards = document.querySelectorAll('.stat-card');
  statCards.forEach((card, index) => {
    setTimeout(() => {
      card.classList.add('fade-in');
    }, index * 200);
  });
}

function requestExchange() {
  const amount = Math.floor(points / 5000) * 5000;
  if (confirm(`${amount}PÎ•º Ï†ÅÎ¶ΩÍ∏àÏúºÎ°ú Ï†ÑÌôòÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
    alert('Ï†ÑÌôò Ïã†Ï≤≠Ïù¥ Ï†ëÏàòÎêòÏóàÏäµÎãàÎã§.\nÍ¥ÄÎ¶¨Ïûê ÌôïÏù∏ ÌõÑ Ï†ÅÎ¶ΩÍ∏àÏúºÎ°ú ÏßÄÍ∏âÎê©ÎãàÎã§.');
  }
}

function showExplanation(isCorrect, explanation) {
  const explanationEl = document.getElementById('explanation');
  explanationEl.textContent = explanation;
  explanationEl.style.display = 'block';
  
  // ÏûêÎèôÏúºÎ°ú ÏÑ§Î™ÖÏù¥ Î≥¥Ïù¥ÎèÑÎ°ù Ïä§ÌÅ¨Î°§
  setTimeout(() => {
    explanationEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }, 100);
}

// ÏÉàÎ°úÏö¥ Î¨∏Ï†ú ÏÑ†ÌÉù Ìï®Ïàò
function selectNewQuestions() {
  // Î™®Îì† Î¨∏Ï†úÎ•º ÎûúÎç§ÏúºÎ°ú ÏÑûÍ∏∞
  questions = allQuestions.sort(() => Math.random() - 0.5);
}

// Í≥ÑÏÜç ÌíÄÍ∏∞ Ìï®Ïàò ÏàòÏ†ï
function continueQuiz() {
  const quizBox = document.getElementById('quiz-box');
  const quizComplete = document.getElementById('quiz-complete');
  
  // ÏÉàÎ°úÏö¥ Î¨∏Ï†ú ÏÑ†ÌÉù
  selectNewQuestions();
  currentIndex = 0;
  startTime = Date.now();
  correctAnswers = 0;
  
  quizComplete.style.display = 'none';
  quizBox.style.display = 'block';
  
  showQuestion();
  updateProgress();
}

// ÌôàÏúºÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞ Ìï®Ïàò Ï∂îÍ∞Ä
function goHome() {
  window.location.href = 'index.html';
}

// Í≥µÏú† Í¥ÄÎ†® Ìï®ÏàòÎì§
function shareApp() {
  if (navigator.share) {
    navigator.share({
      title: 'ÎäòÎ¥Ñ Í±¥Í∞ï ÌÄ¥Ï¶à',
      text: 'ÎÇòÎ•º ÏúÑÌïú ÏûëÏùÄ ÏäµÍ¥ÄÏùò Î≥ÄÌôî, ÎäòÎ¥ÑÍ≥º Ìï®Íªò Í±¥Í∞ïÌïú ÏäµÍ¥ÄÏùÑ ÎßåÎì§Ïñ¥Î≥¥ÏÑ∏Ïöî!',
      url: window.location.href
    })
    .then(() => {
      // Í≥µÏú† ÏÑ±Í≥µ Ïãú Ìè¨Ïù∏Ìä∏ ÏßÄÍ∏â
      addPoints(50);
      showToast('Í≥µÏú† Í∞êÏÇ¨Ìï©ÎãàÎã§! +50PÍ∞Ä Ï†ÅÎ¶ΩÎêòÏóàÏñ¥Ïöî üíö');
    })
    .catch((error) => {
      console.log('Í≥µÏú† Ïã§Ìå®:', error);
    });
  } else {
    // Web Share APIÎ•º ÏßÄÏõêÌïòÏßÄ ÏïäÎäî Í≤ΩÏö∞ Í∏∞Ï°¥ Î≥µÏÇ¨ Í∏∞Îä• ÏÇ¨Ïö©
    copyLink();
  }
}

function shareToInstagram() {
  const url = encodeURIComponent(window.location.href);
  const text = encodeURIComponent('ÎÇòÎ•º ÏúÑÌïú ÏûëÏùÄ ÏäµÍ¥ÄÏùò Î≥ÄÌôî, ÎäòÎ¥ÑÍ≥º Ìï®Íªò Í±¥Í∞ïÌïú ÏäµÍ¥ÄÏùÑ ÎßåÎì§Ïñ¥Î≥¥ÏÑ∏Ïöî!');
  window.open(`https://www.instagram.com/share?url=${url}&caption=${text}`, 'instagram-share-dialog', 'width=800,height=600');
  addPoints(200);
  showToast('Í≥µÏú† Í∞êÏÇ¨Ìï©ÎãàÎã§! +200PÍ∞Ä Ï†ÅÎ¶ΩÎêòÏóàÏñ¥Ïöî üíö');
}

function showToast(message) {
  const toast = document.createElement('div');
  toast.className = 'toast-message';
  toast.textContent = message;
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.classList.add('show');
  }, 100);
  
  setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => {
      document.body.removeChild(toast);
    }, 300);
  }, 3000);
}

function shareAppInstall() {
  const shareUrl = "https://play.google.com/store/apps/details?id=com.neulbom.neulbomquiz";
  if (navigator.share) {
    navigator.share({
      title: "ÎäòÎ¥Ñ Í±¥Í∞ï ÌÄ¥Ï¶à ÌíÄÏñ¥Î¥ê!",
      text: "ÌÄ¥Ï¶à ÌíÄÍ≥† Ìè¨Ïù∏Ìä∏ Î∞õÏïÑÏöî üéÅ",
      url: shareUrl
    }).then(() => {
      addPoints(200);
      showToast('Í≥µÏú† Í∞êÏÇ¨Ìï©ÎãàÎã§! +200PÍ∞Ä Ï†ÅÎ¶ΩÎêòÏóàÏñ¥Ïöî üíö');
    }).catch(() => {});
  } else {
    navigator.clipboard.writeText(shareUrl);
    showToast('ÎßÅÌÅ¨Í∞Ä Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§!');
  }
} 