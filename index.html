<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ëŠ˜ë´„ ê±´ê°• í€´ì¦ˆ</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="css/nickname.css" />
  <link rel="manifest" href="manifest.json" />
  <script src="https://developers.kakao.com/sdk/js/kakao.min.js"></script>
      <!-- Firebase SDK ì¶”ê°€ -->
    <script src="https://www.gstatic.com/firebasejs/9.x.x/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.x.x/firebase-firestore-compat.js"></script>
    <script>
      // Firebase ì´ˆê¸°í™”
      var firebaseConfig = {
        // Firebase ì„¤ì • ì •ë³´ë¥¼ ì—¬ê¸°ì— ì…ë ¥í•˜ì„¸ìš”
      };
      firebase.initializeApp(firebaseConfig);
      var db = firebase.firestore();

    // ì¹´ì¹´ì˜¤ ì´ˆê¸°í™”
    Kakao.init('2c0e3c8b8e6b4c8f9d5a7e1f3b9c6d2e');
    
    // ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ í™•ì¸ìš© ì½”ë“œ
    console.log('ì¸ë¼ì¸ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ë¨');
    
    // ì•± ì„¤ì¹˜ ë°°ë„ˆ ë‹«ê¸° í•¨ìˆ˜
    function closeInstallBanner() {
      var banner = document.getElementById('install-banner');
      if (banner) banner.style.display = 'none';
    }

    // ë‹‰ë„¤ì„ ì¤‘ë³µ ì²´í¬ í•¨ìˆ˜
    async function isNicknameTaken(nickname) {
      const querySnapshot = await db.collection("users")
        .where("nickname", "==", nickname)
        .get();
      return !querySnapshot.empty;
    }

    // ë‹‰ë„¤ì„ ë“±ë¡ í•¨ìˆ˜
    async function registerNickname() {
      const nicknameInput = document.getElementById("nicknameInput");
      const nickname = nicknameInput.value.trim();
      
      if (!nickname) {
        alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }

      try {
        // ì¤‘ë³µ ì²´í¬
        if (await isNicknameTaken(nickname)) {
          alert("ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤.");
          return;
        }

        // userId ìƒì„± ë˜ëŠ” ê°€ì ¸ì˜¤ê¸°
        let userId = localStorage.getItem("userId");
        if (!userId) {
          userId = "user_" + Date.now() + "_" + Math.random().toString(36).substr(2, 8);
          localStorage.setItem("userId", userId);
        }

        // Firestoreì— ì €ì¥
        await db.collection("users").doc(userId).set({
          userId: userId,
          nickname: nickname,
          points: 0,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        localStorage.setItem("nickname", nickname);
        alert("ë‹‰ë„¤ì„ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
        
        // ë‹‰ë„¤ì„ ì…ë ¥ í¼ ìˆ¨ê¸°ê¸° ë° í¬ì¸íŠ¸ í‘œì‹œ
        document.getElementById("nickname-form").style.display = "none";
        document.getElementById("point-display").style.display = "block";
        getMyPoints();
      } catch (error) {
        console.error("Error:", error);
        alert("ë‹‰ë„¤ì„ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    }

    // í¬ì¸íŠ¸ ì¡°íšŒ í•¨ìˆ˜
    async function getMyPoints() {
      const userId = localStorage.getItem("userId");
      if (!userId) {
        alert("ë¡œê·¸ì¸/ë‹‰ë„¤ì„ ë“±ë¡ì´ í•„ìš”í•©ë‹ˆë‹¤.");
        return;
      }

      try {
        const doc = await db.collection("users").doc(userId).get();
        if (doc.exists) {
          const points = doc.data().points || 0;
          document.getElementById("points").textContent = `${points}P`;
        }
      } catch (error) {
        console.error("Error:", error);
        alert("í¬ì¸íŠ¸ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
    window.onload = function() {
      const userId = localStorage.getItem("userId");
      const nickname = localStorage.getItem("nickname");
      
      if (userId && nickname) {
        document.getElementById("nickname-form").style.display = "none";
        document.getElementById("point-display").style.display = "block";
        getMyPoints();
      }
    };
  </script>
  <style>
    .link-copy-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: 100%;
      max-width: 320px;
      height: 60px;
      margin: 24px auto 0 auto;
      background-color: #e0ede3;
      border-radius: 999px;
      color: #356c55;
      font-size: 16px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: background-color 0.2s ease, box-shadow 0.2s;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .link-copy-btn:hover {
      background-color: #d0e5d6;
      box-shadow: 0 4px 12px rgba(53,108,85,0.08);
    }
    .link-copy-btn img {
      width: 22px;
      height: 22px;
      vertical-align: middle;
    }
    @media (max-width: 480px) {
      .link-copy-btn {
        max-width: 95vw;
        height: 48px;
        font-size: 15px;
      }
      .link-copy-btn img {
        width: 18px;
        height: 18px;
      }
    }
    #copy-msg {
      display:none;
      color:#2e7d32;
      font-weight:bold;
      font-size:1.1em;
      margin-top:10px;
    }
    .social-share-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-top: 16px;
    }
    
    .social-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
      border-radius: 8px;
      border: none;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    
    .social-btn:hover {
      opacity: 0.9;
    }
    
    .social-btn img {
      width: 20px;
      height: 20px;
    }
    
    .kakao-btn {
      background-color: #FEE500;
      color: #000000;
    }
    
    .facebook-btn {
      background-color: #1877F2;
      color: #FFFFFF;
    }

    .share-section {
      background: rgba(255, 255, 255, 0.9);
      padding: 24px;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      margin: 24px auto;
      max-width: 600px;
    }

    .share-title {
      color: #356c55;
      font-size: 18px;
      margin-bottom: 16px;
      font-weight: 600;
    }

    .social-share-buttons {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 16px;
    }
    
    .social-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 16px;
      border-radius: 12px;
      border: none;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .social-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .social-btn img {
      width: 24px;
      height: 24px;
    }
    
    .kakao-btn {
      background-color: #FEE500;
      color: #000000;
    }
    
    .facebook-btn {
      background-color: #1877F2;
      color: #FFFFFF;
    }

    .instagram-btn {
      background: linear-gradient(45deg, #405DE6, #5851DB, #833AB4, #C13584, #E1306C, #FD1D1D);
      color: #FFFFFF;
    }

    .line-btn {
      background-color: #06C755;
      color: #FFFFFF;
    }

    .share-reward {
      color: #356c55;
      font-size: 14px;
      margin-top: 12px;
      font-weight: 500;
    }

    @media (max-width: 480px) {
      .social-share-buttons {
        grid-template-columns: 1fr;
      }
      
      .share-section {
        margin: 16px;
        padding: 16px;
      }
    }

    .install-btn {
      background-color: #356c55;
      color: #fff;
    }

    /* ì¹´ë“œí˜• í”¼ë“œ UI ìŠ¤íƒ€ì¼ */
    .feed-card {
      background: #ffffff;
      border-radius: 18px;
      box-shadow: 0 2px 10px rgba(53,108,85,0.06);
      margin-bottom: 20px;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .feed-card:hover {
      box-shadow: 0 4px 20px rgba(53,108,85,0.12);
      transform: translateY(-2px);
    }

    .feed-card-image {
      width: 100%;
      height: 200px;
      object-fit: cover;
      border-radius: 0;
    }

    .feed-card-content {
      padding: 20px;
    }

    .feed-card-title {
      font-size: 18px;
      font-weight: 700;
      color: #2c2c2c;
      margin-bottom: 8px;
      line-height: 1.4;
    }

    .feed-card-preview {
      font-size: 15px;
      color: #666;
      line-height: 1.6;
      margin-bottom: 16px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .feed-card-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
      color: #888;
      margin-bottom: 16px;
    }

    .feed-card-author {
      display: flex;
      align-items: center;
    }

    .feed-card-avatar {
      width: 24px;
      height: 24px;
      background: #e0ede3;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: #356c55;
      font-weight: 600;
    }

    .feed-card-stats {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .feed-card-stat {
      display: flex;
      align-items: center;
      gap: 4px;
      color: #666;
    }

    .feed-card-comments {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 16px;
      margin-top: 16px;
      display: none;
    }

    .feed-card-comments.active {
      display: block;
    }

    .feed-comment {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid #eee;
    }

    .feed-comment:last-child {
      margin-bottom: 0;
      padding-bottom: 0;
      border-bottom: none;
    }

    .feed-comment-avatar {
      width: 28px;
      height: 28px;
      background: #e0ede3;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      color: #356c55;
      font-weight: 600;
      flex-shrink: 0;
    }

    .feed-comment-content {
      flex: 1;
    }

    .feed-comment-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .feed-comment-author {
      font-size: 13px;
      font-weight: 600;
      color: #356c55;
    }

    .feed-comment-time {
      font-size: 12px;
      color: #999;
    }

    .feed-comment-text {
      font-size: 14px;
      color: #333;
      line-height: 1.5;
    }

    .feed-comment-input-section {
      margin-top: 16px;
      display: flex;
      gap: 12px;
      padding: 16px;
      background: #fafbfc;
      border-radius: 16px;
      border: 1px solid #e8ebed;
      transition: all 0.2s ease;
    }

    .feed-comment-input-section:focus-within {
      border-color: #356c55;
      background: #ffffff;
      box-shadow: 0 0 0 3px rgba(53,108,85,0.08);
    }

    .feed-comment-input {
      flex: 1;
      padding: 12px 16px;
      border: none;
      border-radius: 24px;
      font-size: 15px;
      background: #ffffff;
      outline: none;
      transition: all 0.2s ease;
      color: #333;
      line-height: 1.4;
      min-height: 20px;
      resize: none;
    }

    .feed-comment-input::placeholder {
      color: #9ca3af;
      font-weight: 400;
    }

    .feed-comment-input:focus {
      background: #ffffff;
      box-shadow: 0 2px 8px rgba(53,108,85,0.05);
    }

    .feed-comment-submit {
      padding: 12px 20px;
      background: #356c55;
      color: white;
      border: none;
      border-radius: 24px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
      min-width: 70px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .feed-comment-submit:hover:not(:disabled) {
      background: #2a5544;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(53,108,85,0.2);
    }

    .feed-comment-submit:disabled {
      background: #d1d5db;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .feed-comment-submit:active:not(:disabled) {
      transform: translateY(0);
    }

    /* ëŒ“ê¸€ ì…ë ¥ ê¸€ì ìˆ˜ í‘œì‹œ */
    .comment-char-count {
      position: absolute;
      bottom: -20px;
      right: 16px;
      font-size: 12px;
      color: #9ca3af;
      transition: color 0.2s ease;
    }

    .comment-char-count.warning {
      color: #f59e0b;
    }

    .comment-char-count.error {
      color: #ef4444;
    }

    /* ëŒ“ê¸€ ì…ë ¥ ì„¹ì…˜ ì»¨í…Œì´ë„ˆ */
    .comment-input-container {
      position: relative;
      margin-bottom: 24px;
    }

    /* í† ìŠ¤íŠ¸ ì•Œë¦¼ ê³ ë„í™” */
    .salon-toast {
      position: fixed !important;
      bottom: 24px !important;
      left: 50% !important;
      transform: translateX(-50%) !important;
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%) !important;
      color: white !important;
      padding: 16px 24px !important;
      border-radius: 28px !important;
      font-size: 15px !important;
      font-weight: 600 !important;
      z-index: 10001 !important;
      box-shadow: 0 8px 32px rgba(76, 175, 80, 0.3), 
                  0 4px 16px rgba(0, 0, 0, 0.1) !important;
      backdrop-filter: blur(8px) !important;
      border: 1px solid rgba(255, 255, 255, 0.2) !important;
      max-width: 90vw !important;
      min-width: 280px !important;
      text-align: center !important;
    }

    .salon-toast.error {
      background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%) !important;
      box-shadow: 0 8px 32px rgba(244, 67, 54, 0.3), 
                  0 4px 16px rgba(0, 0, 0, 0.1) !important;
    }

    .salon-toast.warning {
      background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%) !important;
      box-shadow: 0 8px 32px rgba(255, 152, 0, 0.3), 
                  0 4px 16px rgba(0, 0, 0, 0.1) !important;
    }

    .salon-toast-content {
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      gap: 12px !important;
    }

    .salon-toast-icon {
      font-size: 18px !important;
      display: inline-block !important;
      animation: toastIconBounce 0.6s ease !important;
    }

    .salon-toast-message {
      font-weight: 600 !important;
      letter-spacing: -0.02em !important;
    }

    /* í† ìŠ¤íŠ¸ ì• ë‹ˆë©”ì´ì…˜ */
    @keyframes toastSlideUp {
      0% {
        transform: translateX(-50%) translateY(120%);
        opacity: 0;
        scale: 0.9;
      }
      100% {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
        scale: 1;
      }
    }

    @keyframes toastSlideDown {
      0% {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
        scale: 1;
      }
      100% {
        transform: translateX(-50%) translateY(120%);
        opacity: 0;
        scale: 0.9;
      }
    }

    @keyframes toastIconBounce {
      0%, 20%, 50%, 80%, 100% {
        transform: translateY(0);
      }
      40% {
        transform: translateY(-4px);
      }
      60% {
        transform: translateY(-2px);
      }
    }

    /* ëŒ“ê¸€ ì„¹ì…˜ í—¤ë” */
    .comments-section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      padding: 0 4px;
    }

    .comments-count {
      font-size: 14px;
      font-weight: 600;
      color: #6b7280;
    }

    .comments-sort {
      font-size: 12px;
      color: #9ca3af;
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 6px;
      transition: background 0.2s ease;
    }

    .comments-sort:hover {
      background: #f3f4f6;
    }

    /* ëŒ“ê¸€ ì…ë ¥ ìƒíƒœ í‘œì‹œ */
    .comment-input-status {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
      padding: 0 16px;
    }

    .input-status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #d1d5db;
      transition: background 0.2s ease;
    }

    .input-status-dot.active {
      background: #356c55;
      animation: statusPulse 2s infinite;
    }

    .input-status-text {
      font-size: 12px;
      color: #6b7280;
      font-weight: 500;
    }

    @keyframes statusPulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.5;
      }
    }

    /* ëª¨ë°”ì¼ ìµœì í™” */
    @media (max-width: 768px) {
      .feed-comment-input-section {
        margin: 12px 8px 0;
        padding: 12px;
        gap: 8px;
      }

      .feed-comment-input {
        padding: 10px 14px;
        font-size: 14px;
      }

      .feed-comment-submit {
        padding: 10px 16px;
        font-size: 14px;
        min-width: 60px;
        height: 40px;
      }

      .salon-toast {
        bottom: 20px !important;
        margin: 0 16px !important;
        min-width: auto !important;
        max-width: calc(100vw - 32px) !important;
        padding: 14px 20px !important;
        font-size: 14px !important;
      }

      .comment-char-count {
        bottom: -18px;
        right: 12px;
        font-size: 11px;
      }
    }

    /* ëŒ“ê¸€ ì¹´ìš´íŠ¸ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì• ë‹ˆë©”ì´ì…˜ */
    .comment-count-update {
      animation: countUpdate 0.3s ease;
    }

    @keyframes countUpdate {
      0% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.2);
        color: #356c55;
      }
      100% {
        transform: scale(1);
      }
    }

    /* ëŒ“ê¸€ ë“±ë¡ ì„±ê³µ ì‹œ ì…ë ¥ì°½ ì• ë‹ˆë©”ì´ì…˜ */
    .comment-input-success {
      animation: inputSuccess 0.5s ease;
    }

    @keyframes inputSuccess {
      0% {
        background: #fafbfc;
      }
      50% {
        background: rgba(76, 175, 80, 0.1);
        border-color: #4CAF50;
      }
      100% {
        background: #fafbfc;
      }
    }

    /* ì¸ìŠ¤íƒ€ ìŠ¤íƒ€ì¼ ì¹´ë“œ ìŠ¬ë¼ì´ë“œ UI */
    .card-slider-container {
      position: relative;
      width: 100%;
      max-width: 400px;
      margin: 0 auto;
      overflow: hidden;
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(53,108,85,0.15);
    }

    .card-slider {
      display: flex;
      transition: transform 0.3s ease;
      width: 100%;
    }

    .story-card {
      min-width: 100%;
      background: #ffffff;
      border-radius: 20px;
      overflow: hidden;
      position: relative;
    }

    .story-card-image {
      width: 100%;
      max-width: 100%;
      height: auto;
      max-height: 500px;
      object-fit: contain;
      display: block;
      margin: 0 auto;
      background: #f8f9fa;
      border-radius: 16px;
    }

    .story-card-content {
      padding: 24px;
    }

    .story-card-title {
      font-size: 20px;
      font-weight: 700;
      color: #2c2c2c;
      margin-bottom: 12px;
      line-height: 1.4;
    }

    .story-card-text {
      font-size: 16px;
      color: #555;
      line-height: 1.6;
      margin-bottom: 20px;
    }

    .story-card-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid #f0f0f0;
    }

    .story-card-author {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .story-card-avatar {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, #356c55 0%, #4a7c59 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      color: white;
      font-weight: 700;
    }

    .story-card-author-info {
      display: flex;
      flex-direction: column;
    }

    .story-card-author-name {
      font-size: 15px;
      font-weight: 600;
      color: #356c55;
    }

    .story-card-time {
      font-size: 13px;
      color: #999;
    }

    .story-card-actions {
      display: flex;
      gap: 16px;
    }

    .story-action-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      background: none;
      border: none;
      cursor: pointer;
      padding: 8px 12px;
      border-radius: 20px;
      transition: all 0.2s ease;
      font-size: 14px;
      font-weight: 600;
    }

    .story-action-btn:hover {
      background: rgba(53,108,85,0.1);
    }

    .story-action-btn.liked {
      color: #e74c3c;
    }

    .story-action-btn.comment-btn {
      color: #356c55;
    }

    /* ì¹´ë“œ ë„¤ë¹„ê²Œì´ì…˜ */
    .card-nav {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255,255,255,0.9);
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      color: #356c55;
      transition: all 0.2s ease;
      z-index: 10;
    }

    .card-nav:hover {
      background: rgba(255,255,255,1);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .card-nav.prev {
      left: 16px;
    }

    .card-nav.next {
      right: 16px;
    }

    .card-nav:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    /* ì¹´ë“œ ì¸ë””ì¼€ì´í„° */
    .card-indicators {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-top: 16px;
    }

    .card-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #ddd;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .card-indicator.active {
      background: #356c55;
      transform: scale(1.2);
    }

    /* ëŒ“ê¸€ ì˜ì—­ (ì¹´ë“œ í•˜ë‹¨) */
    .story-comments-section {
      background: #fafbfc;
      border-top: 1px solid #f0f0f0;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .story-comments-section.active {
      max-height: 400px;
    }

    .story-comments-header {
      padding: 16px 24px 0;
      font-size: 14px;
      font-weight: 600;
      color: #666;
    }

    .story-comments-list {
      padding: 16px 24px;
      max-height: 200px;
      overflow-y: auto;
    }

    .story-comment {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
    }

    .story-comment:last-child {
      margin-bottom: 0;
    }

    .story-comment-avatar {
      width: 32px;
      height: 32px;
      background: #e0ede3;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: #356c55;
      font-weight: 600;
      flex-shrink: 0;
    }

    .story-comment-content {
      flex: 1;
    }

    .story-comment-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .story-comment-author {
      font-size: 13px;
      font-weight: 600;
      color: #356c55;
    }

    .story-comment-time {
      font-size: 12px;
      color: #999;
    }

    .story-comment-text {
      font-size: 14px;
      color: #333;
      line-height: 1.5;
    }

    .story-comment-input {
      padding: 16px 24px;
      border-top: 1px solid #f0f0f0;
    }

    .story-comment-form {
      display: flex;
      gap: 12px;
      align-items: flex-end;
    }

    .story-comment-textarea {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid #e0e0e0;
      border-radius: 20px;
      font-size: 14px;
      resize: none;
      outline: none;
      transition: border-color 0.2s ease;
      min-height: 40px;
      max-height: 80px;
    }

    .story-comment-textarea:focus {
      border-color: #356c55;
    }

    .story-comment-submit {
      padding: 12px 20px;
      background: #356c55;
      color: white;
      border: none;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
    }

    .story-comment-submit:hover:not(:disabled) {
      background: #2a5544;
    }

    .story-comment-submit:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    /* ì§ˆë¬¸ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
    .question-card {
      background: linear-gradient(135deg, #356c55 0%, #4a7c59 100%);
      color: white;
    }

    .question-card .story-card-title {
      color: white;
      font-size: 22px;
    }

    .question-card .story-card-text {
      color: rgba(255,255,255,0.9);
    }

    .question-options {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 20px;
    }

    .question-option {
      padding: 16px 20px;
      background: rgba(255,255,255,0.1);
      border: 2px solid rgba(255,255,255,0.2);
      border-radius: 12px;
      color: white;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 15px;
      font-weight: 500;
    }

    .question-option:hover {
      background: rgba(255,255,255,0.2);
      border-color: rgba(255,255,255,0.4);
    }

    .question-option:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .question-reward {
      text-align: center;
      margin-top: 16px;
      font-size: 14px;
      color: rgba(255,255,255,0.8);
    }

    /* ëª¨ë°”ì¼ ìµœì í™” */
    @media (max-width: 768px) {
      .card-slider-container {
        max-width: 95vw;
        margin: 0 auto;
      }

      .story-card-content {
        padding: 20px;
      }

      .story-card-title {
        font-size: 18px;
      }

      .story-card-text {
        font-size: 15px;
      }

      .card-nav {
        width: 36px;
        height: 36px;
        font-size: 16px;
      }

      .card-nav.prev {
        left: 12px;
      }

      .card-nav.next {
        right: 12px;
      }
    }

    /* ì „ì²´ í™”ë©´ í˜ì´ì§€ ì „í™˜ ìŠ¤íƒ€ì¼ */
    .fullscreen-page {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100vh;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      z-index: 1000;
      overflow-y: auto;
      transform: translateX(100%);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .fullscreen-page.active {
      transform: translateX(0);
    }

    .fullscreen-page-header {
      position: sticky;
      top: 0;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 16px;
      border-bottom: 1px solid #e9ecef;
      display: flex;
      align-items: center;
      justify-content: space-between;
      z-index: 10;
    }

    .fullscreen-back-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      background: #356c55;
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .fullscreen-back-btn:hover {
      background: #2a5544;
      transform: translateY(-1px);
    }

    .fullscreen-page-title {
      font-size: 20px;
      font-weight: 700;
      color: #356c55;
      margin: 0;
    }

    .fullscreen-page-content {
      padding: 20px;
      max-width: 600px;
      margin: 0 auto;
      min-height: calc(100vh - 80px);
    }

    /* ëª¨ë°”ì¼ ìµœì í™” */
    @media (max-width: 768px) {
      .fullscreen-page-header {
        padding: 12px 16px;
      }

      .fullscreen-back-btn {
        padding: 10px 14px;
        font-size: 15px;
      }

      .fullscreen-page-title {
        font-size: 18px;
      }

      .fullscreen-page-content {
        padding: 16px;
      }

      .card-slider-container {
        margin: 0 -8px;
      }
    }

    /* í˜ì´ì§€ ì „í™˜ ì• ë‹ˆë©”ì´ì…˜ */
    .page-transition-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100vh;
      background: rgba(53, 108, 85, 0.8);
      z-index: 999;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    .page-transition-overlay.active {
      opacity: 1;
      pointer-events: auto;
    }

    /* 1. í”Œë¡œíŒ… ê¸€ì“°ê¸° ë²„íŠ¼ CSS ì¶”ê°€ (body í•˜ë‹¨ ê³ ì •) */
    .floating-write-btn {
      position: fixed;
      right: 24px;
      bottom: 24px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: linear-gradient(135deg, #4CAF50, #2E7D32);
      color: white;
      font-size: 24px;
      border: none;
      box-shadow: 0 4px 12px rgba(46, 125, 50, 0.3);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      z-index: 99995;
    }

    .floating-write-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 16px rgba(46, 125, 50, 0.4);
    }

    .floating-write-btn:active {
      transform: scale(0.95);
    }

    @media (max-width: 768px) {
      .floating-write-btn {
        right: 16px;
        bottom: 16px;
        width: 48px;
        height: 48px;
        font-size: 20px;
      }
    }

    /* ê¸€ì“°ê¸° ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
    #free-write-fullscreen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100vh;
      background: rgba(0,0,0,0.5);
      z-index: 100000;
      display: none;
      justify-content: center;
      align-items: center;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
    }

    #free-write-fullscreen.active {
      display: flex;
      opacity: 1;
      visibility: visible;
    }

    #free-write-fullscreen.closing {
      opacity: 0;
    }

    .modal-content {
      width: 90%;
      max-width: 600px;
      background: #fff;
      border-radius: 24px;
      box-shadow: 0 8px 32px rgba(53,108,85,0.15);
      padding: 28px;
      position: relative;
      transform: translateY(20px);
      transition: all 0.3s ease;
      margin: 20px;
    }

    #free-write-fullscreen.active .modal-content {
      transform: translateY(0);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .modal-header h2 {
      font-size: 20px;
      color: #356c55;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .modal-close-btn {
      width: 32px;
      height: 32px;
      background: none;
      border: none;
      font-size: 24px;
      color: #666;
      cursor: pointer;
      padding: 0;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .modal-close-btn:hover {
      background: #f5f5f5;
      transform: scale(1.1);
    }

    .write-guide {
      background: #f5f9f6;
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 24px;
    }

    .write-guide p {
      color: #356c55;
      font-weight: 600;
      margin: 0 0 8px;
    }

    .write-guide ul {
      margin: 0;
      padding-left: 20px;
      color: #4a7c59;
      font-size: 14px;
    }

    .write-guide li {
      margin: 4px 0;
    }

    .write-textarea-container {
      position: relative;
      margin-bottom: 32px;
    }

    #habit-salon-free-content {
      width: 100%;
      min-height: 200px;
      padding: 16px;
      border: 2px solid #e0ede3;
      border-radius: 12px;
      font-size: 15px;
      line-height: 1.6;
      resize: none;
      transition: all 0.2s ease;
    }

    #habit-salon-free-content:focus {
      outline: none;
      border-color: #4CAF50;
      box-shadow: 0 0 0 3px rgba(76,175,80,0.1);
    }

    .char-counter {
      position: absolute;
      right: 16px;
      bottom: -24px;
      font-size: 13px;
      color: #666;
    }

    .write-modal-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 32px;
    }

    .point-info {
      color: #666;
      font-size: 14px;
    }

    .write-modal-actions {
      display: flex;
      gap: 12px;
    }

    .write-cancel-btn {
      padding: 12px 20px;
      background: #f5f5f5;
      color: #666;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      cursor: pointer;
    }

    .write-submit-btn {
      padding: 12px 24px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .write-submit-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .point-badge {
      background: rgba(255,255,255,0.2);
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 13px;
    }

    .fullscreen-page-content {
      min-width: 0 !important;
      min-height: 0 !important;
      max-width: none !important;
      max-height: none !important;
      display: block !important;
    }

    .fullscreen-page.active {
      transform: none !important;
    }

    #habit-salon-free {
      margin: 0 !important;
      padding: 0 !important;
      /* ì´ë¯¸ ë“¤ì–´ê°„ position, width, height, z-index, overflowëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€ */
    }
    #habit-salon-free-list {
      min-height: 0 !important;
      margin-top: 0 !important;
      padding-top: 0 !important;
    }
    #habit-salon-free.fullscreen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      z-index: 9999;
      margin: 0 !important;
      padding: 0 !important;
      box-shadow: none !important;
      border-radius: 0 !important;
      overflow-y: auto;
      display: block !important;
    }
    #habit-salon-free.fullscreen .fullscreen-back-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 16px 20px;
      background: #356c55;
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin: 20px 0 0 20px;
      z-index: 10001;
    }
    #habit-salon-free.fullscreen .fullscreen-back-btn:hover {
      background: #2a5544;
    }
    #habit-salon-free.fullscreen .fullscreen-page-title {
      font-size: 22px;
      font-weight: 700;
      color: #356c55;
      margin: 0 0 24px 0;
      padding-left: 20px;
    }
    #habit-salon-free.fullscreen .habit-salon-free-list {
      max-width: 600px;
      margin: 0 auto;
      padding: 0 16px 40px 16px;
    }

    /* ì „ì²´ ë ˆì´ì•„ì›ƒ */
    body {
      background-color: #f8f8f8;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }

    /* ìƒë‹¨ íƒ€ì´í‹€ ì„¹ì…˜ */
    .title-section {
      text-align: center;
      padding: 40px 20px;
      max-width: 600px;
      margin: 0 auto;
    }

    .title-section h1 {
      color: #356c55;
      font-size: 24px;
      margin-bottom: 16px;
      font-weight: 700;
    }

    .title-section p {
      color: #666;
      font-size: 16px;
    }

    /* ë¡œê³  ì„¹ì…˜ */
    .logo-section {
      text-align: center;
      margin: 40px 0;
    }

    .logo-image {
      width: 120px;
      height: auto;
    }

    /* í•˜ë‹¨ ì¹´ë“œ ì„¹ì…˜ */
    .card-section {
      background: #fff;
      border-radius: 20px 20px 0 0;
      padding: 40px 20px;
      text-align: center;
      margin-top: 40px;
      box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.05);
    }

    .card-section h2 {
      color: #356c55;
      font-size: 20px;
      margin-bottom: 12px;
      font-weight: 700;
    }

    .card-section p {
      color: #666;
      font-size: 15px;
      margin-bottom: 32px;
    }

    /* ë‹‰ë„¤ì„ ì…ë ¥ í¼ */
    .form-group {
      display: flex;
      gap: 8px;
      max-width: 500px;
      margin: 0 auto;
      padding: 0 20px;
      flex-wrap: wrap;
    }

    .nickname-input {
      flex: 1;
      min-width: 200px;
      height: 48px;
      padding: 0 24px;
      border: 1px solid #e0e0e0;
      border-radius: 999px;
      font-size: 15px;
      background: #fff;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .nickname-input:focus {
      outline: none;
      border-color: #356c55;
    }

    .register-button {
      height: 48px;
      padding: 0 32px;
      background-color: #356c55;
      color: white;
      border: none;
      border-radius: 999px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
      box-shadow: 0 2px 8px rgba(53, 108, 85, 0.2);
      width: 100%;
      max-width: 120px;
    }

    .register-button:hover {
      background-color: #2a5644;
    }

    @media screen and (max-width: 430px) {
      .form-group {
        padding: 0 12px;
      }
      
      .nickname-input {
        width: 100%;
        min-width: 0;
      }
      
      .register-button {
        width: 100%;
        max-width: none;
      }
    }

    /* í¬ì¸íŠ¸ í‘œì‹œ ì˜ì—­ */
    .app-start-button {
      width: 100%;
      max-width: 320px;
      height: 48px;
      background-color: #356c55;
      color: white;
      border: none;
      border-radius: 999px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      margin: 24px auto;
      display: block;
    }

    .points-info {
      color: #356c55;
      font-size: 14px;
      margin: 16px 0;
    }

    .current-points {
      color: #666;
      font-size: 14px;
    }

    #points {
      color: #356c55;
      font-weight: 600;
    }

    .nickname-form {
      display: flex;
      gap: 8px;
      margin: 16px auto;
      max-width: 320px;
    }

    .nickname-input {
      flex: 1;
      padding: 12px 16px;
      border: 2px solid #e0ede3;
      border-radius: 8px;
      font-size: 15px;
      color: #333;
      transition: border-color 0.2s ease;
    }

    .nickname-input:focus {
      outline: none;
      border-color: #356c55;
    }

    .nickname-button {
      padding: 12px 20px;
      background: #356c55;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s ease;
      white-space: nowrap;
    }

    .nickname-button:hover {
      background: #2a5544;
    }

    .nickname-button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    /* ëª¨ë°”ì¼ ë°˜ì‘í˜• ìŠ¤íƒ€ì¼ */
    @media screen and (max-width: 768px) {
      body {
        overflow-x: hidden;
      }
      
      .container {
        width: 100%;
        padding: 0 16px;
        box-sizing: border-box;
      }
      
      .card {
        width: 100%;
        margin: 16px 0;
        box-sizing: border-box;
      }
      
      .story-card {
        width: 100%;
        margin: 16px 0;
        box-sizing: border-box;
      }
      
      .story-card-image {
        width: 100%;
        height: auto;
        aspect-ratio: 16/9;
        object-fit: cover;
      }
      
      .story-card-content {
        padding: 16px;
      }
      
      .story-comments-section {
        width: 100%;
        box-sizing: border-box;
      }
      
      .story-comment-form {
        flex-direction: column;
        gap: 8px;
      }
      
      .story-comment-textarea {
        width: 100%;
        box-sizing: border-box;
      }
      
      .story-comment-submit {
        width: 100%;
        margin-top: 8px;
      }
      
      /* ë‹‰ë„¤ì„ ì…ë ¥ í¼ ëª¨ë°”ì¼ ìŠ¤íƒ€ì¼ */
      .nickname-input-container {
        width: 100%;
        padding: 16px;
        box-sizing: border-box;
      }
      
      .nickname-input {
        width: 100%;
        box-sizing: border-box;
      }
      
      .nickname-submit {
        width: 100%;
        margin-top: 8px;
      }
      
      /* ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ ëª¨ë°”ì¼ ìŠ¤íƒ€ì¼ */
      .card-nav {
        width: 40px;
        height: 40px;
        font-size: 24px;
      }
      
      .card-nav.prev {
      }
    }

    /* ë¸Œëœë“œ ì´ì•¼ê¸° ì¹´ë“œ í…ìŠ¤íŠ¸ ì „ì²´ ë³´ì´ê¸° (ëª¨ë°”ì¼ í¬í•¨) */
    .story-card .story-card-text,
    .story-card-text,
    .feed-card-preview,
    .feed-card-text {
      display: block !important;
      -webkit-line-clamp: unset !important;
      -webkit-box-orient: unset !important;
      overflow: visible !important;
      max-height: none !important;
      text-overflow: unset !important;
      white-space: pre-line !important;
      height: auto !important;
    }

    /* ë”ë³´ê¸° ë²„íŠ¼ ìˆ¨ê¸°ê¸° */
    .feed-card-more-btn {
      display: none !important;
    }

    /* ë¸Œëœë“œ ì´ì•¼ê¸° ì¹´ë“œ ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ ê°œì„  - ëª¨ë“  ê¸°ì¡´ ìŠ¤íƒ€ì¼ ë®ì–´ì“°ê¸° */
    .story-card .story-card-image,
    .card-slider .story-card-image,
    .story-card-image {
      width: 100% !important;
      height: auto !important;
      max-height: none !important;
      min-height: auto !important;
      object-fit: contain !important;
      border-radius: 16px !important;
      background: #f8f9fa !important;
      display: block !important;
      margin: 0 auto !important;
      aspect-ratio: unset !important;
    }

    /* ëª¨ë°”ì¼ì—ì„œë„ ë™ì¼í•˜ê²Œ ì ìš© */
    @media screen and (max-width: 768px) {
      .story-card .story-card-image,
      .card-slider .story-card-image,
      .story-card-image {
        width: 100% !important;
        height: auto !important;
        max-height: none !important;
        aspect-ratio: unset !important;
        object-fit: contain !important;
      }
    }

    @media (max-width: 480px) {
      .story-card .story-card-image,
      .card-slider .story-card-image,
      .story-card-image {
        width: 100% !important;
        height: auto !important;
        max-height: none !important;
        object-fit: contain !important;
      }
    }

    /* ì´ë¯¸ì§€ê°€ ì—†ì„ ë•Œ ê¸°ë³¸ ì•„ì´ì½˜ í‘œì‹œ ì˜ì—­ */
    .story-card .story-card-image[style*="display:flex"] {
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      background: linear-gradient(135deg, #356c55 0%, #4a7c59 100%) !important;
      color: white !important;
      font-size: 48px !important;
    }
  </style>
</head>
<body>
  

  <!-- ìŒì†Œê±° ë²„íŠ¼ ì¶”ê°€ -->
  <button id="mute-button" class="mute-button" onclick="toggleMute()" title="íš¨ê³¼ìŒ ì¼œê¸°/ë„ê¸°">
    ğŸ”Š
  </button>
  <div id="install-banner" style="display:block; position:fixed; bottom:0; left:0; width:100%; background:#ffffff; padding:16px; text-align:center; z-index:9999; box-shadow:0 -2px 10px rgba(0,0,0,0.2); border-top:1px solid #eee;">
    <div style="max-width:460px; margin:0 auto; display:flex; align-items:center; justify-content:space-between; gap:12px;">
      <div style="flex:1; text-align:left;">
        <p style="margin:0; font-size:16px; font-weight:600; color:#356c55;">ğŸ“± ì•± ì„¤ì¹˜í•˜ê³  ë” í¸ë¦¬í•˜ê²Œ ì´ìš©í•´ë³´ì„¸ìš”!</p>
        <p style="margin:4px 0 0; font-size:14px; color:#666;">ì„¤ì¹˜í•˜ë©´ í™ˆ í™”ë©´ì—ì„œ ë°”ë¡œ ì‹¤í–‰í•  ìˆ˜ ìˆì–´ìš”</p>
      </div>
      <div style="display:flex; gap:8px;">
        <button onclick="closeInstallBanner()" style="padding:8px 16px; border:none; background:#f0f0f0; border-radius:6px; color:#666; font-size:14px; cursor:pointer; font-weight:500;">ë‹«ê¸°</button>
        <a href="https://play.google.com/store/apps/details?id=com.neulbom.neulbomquiz" target="_blank" style="padding:8px 20px; border:none; background:#356c55; border-radius:6px; color:#fff; font-size:14px; text-decoration:none; font-weight:500;">ì„¤ì¹˜í•˜ê¸°</a>
      </div>
    </div>
  </div>

  <!-- ê¸€ì“°ê¸° ëª¨ë‹¬ -->
  <div id="free-write-fullscreen" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h2>âœï¸ ê±´ê°• ì´ì•¼ê¸° ì“°ê¸°</h2>
        <button class="modal-close-btn" onclick="window.closeWriteModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <form id="habit-salon-free-form">
          <div class="write-guide">
            <p>ğŸ’¡ 100ì ì´ìƒ ì‘ì„± ì‹œ 100Pê°€ ì ë¦½ë©ë‹ˆë‹¤!</p>
            <ul>
              <li>ì‹¤ì œ ê²½í—˜í•œ ê±´ê°• ê´€ë¦¬ ë°©ë²•</li>
              <li>íš¨ê³¼ë¥¼ ë³¸ ìš´ë™ì´ë‚˜ ì‹ë‹¨</li>
              <li>ë‚˜ë§Œì˜ ê±´ê°• ìŠµê´€ê³¼ ê¿€íŒ</li>
            </ul>
          </div>
          <div class="write-textarea-container">
            <textarea id="habit-salon-free-content" 
                      placeholder="ê±´ê°•ê³¼ ê´€ë ¨ëœ ê²½í—˜ê³¼ ë…¸í•˜ìš°ë¥¼ 100ì ì´ìƒ ì‘ì„±í•´ì£¼ì„¸ìš”."
                      maxlength="500"></textarea>
            <div class="char-counter">0/500</div>
          </div>
          <div class="char-count-guide">ë” ìì„¸í•œ ì´ì•¼ê¸°ë¥¼ ë“¤ë ¤ì£¼ì„¸ìš”! (100ì í•„ìš”)</div>
          <div class="modal-footer">
            <div class="modal-actions">
              <button type="button" class="cancel-btn" onclick="window.closeWriteModal()">ì·¨ì†Œ</button>
              <button type="submit" class="submit-btn" disabled>
                <span>ê±´ê°• ì´ì•¼ê¸° ê³µìœ í•˜ê¸°</span>
                <span class="point-badge">+100P</span>
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="container">
    <img src="assets/img/logo.png" alt="ëŠ˜ë´„ ë¡œê³ " class="logo">
    <div id="main-section">
      <div class="start-screen">
        <h1 class="main-title">ë‚˜ë¥¼ ìœ„í•œ ì‘ì€ ìŠµê´€ì˜ ë³€í™”, ëŠ˜ë´„</h1>
        <p class="sub-title">ì˜¤ëŠ˜ë„ ë‚˜ë¥¼ ëŒë³´ëŠ” ê°€ì¥ ì‰¬ìš´ ë°©ë²•, ì‹œì‘í•´ë³¼ê¹Œìš”?</p>
        <div style="text-align:center;">
          <div class="share-section">
            <h3 class="share-title">ì¹œêµ¬ì™€ í•¨ê»˜ ê±´ê°•í•œ ìŠµê´€ ë§Œë“¤ê¸°</h3>
            
            <!-- ë‹‰ë„¤ì„ ì…ë ¥ í¼ -->
            <div id="nickname-form" class="nickname-form" style="margin-bottom: 20px;">
              <input type="text" id="nicknameInput" class="nickname-input" placeholder="ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”">
              <button onclick="registerNickname()" class="nickname-button">ë“±ë¡í•˜ê¸°</button>
            </div>

            <div class="social-share-buttons-wrapper">
              <div class="social-share-buttons">
                <button onclick="shareAppInstall()" class="social-btn install-btn">
                  <span class="install-icon-wrap"><img src="assets/img/icon-512.png" alt="ì•±ì„¤ì¹˜" class="install-icon" /></span>
                  <span class="install-btn-text">ì•± ì„¤ì¹˜ ë§í¬ ê³µìœ </span>
                </button>
              </div>
            </div>
            <p class="share-reward">ê³µìœ í•˜ë©´ 200Pê°€ ì ë¦½ë©ë‹ˆë‹¤! ğŸ’š</p>
          </div>
        </div>
        <div class="points-info">
          <p class="current-points">
            ğŸ’š í˜„ì¬ ë‚˜ì˜ ìŠµê´€ í¬ì¸íŠ¸: <strong class="point-value" id="points">0</strong>P
          </p>
          <div class="points-guide">
            <p class="point-main-text">
              ğŸ“Œ <strong class="point-highlight">5,000í¬ì¸íŠ¸</strong>ë¥¼ ë‹¬ì„±í•˜ë©´
              <strong>ëŠ˜ë´„ëª° ì ë¦½ê¸ˆìœ¼ë¡œ ì „í™˜</strong>í•  ìˆ˜ ìˆì–´ìš”!
            </p>
            <p class="point-sub-text">
              í™˜ì „ ì‹ ì²­ ë²„íŠ¼ì€ <strong class="point-emphasis">5,000P ì´ìƒ</strong>ì¼ ë•Œ ìë™ìœ¼ë¡œ í™œì„±í™”ë©ë‹ˆë‹¤
            </p>
          </div>
          <div id="points-action">
            <button id="habit-salon-enter-btn" class="primary-button" style="margin-bottom:12px;background:#356c55;">ğŸŒ¿ ëŠ˜ë´„ ìŠµê´€ì‚´ë¡±</button>
            <button onclick="location.href='quiz.html'" class="primary-button">
              ì˜¤ëŠ˜ì˜ ê±´ê°• ë£¨í‹´ ì‹œì‘í•˜ê¸° â†’
            </button>
            <button onclick="requestExchange()" id="exchange-button" class="secondary-button" style="display: none;">
              âœ¨ í¬ì¸íŠ¸ ì „í™˜ ì‹ ì²­í•˜ê¸°
            </button>
            <button onclick="window.open('https://smartstore.naver.com/jinjjamall', '_blank')" class="secondary-button" style="margin-top:10px;">
              ğŸ›’ ëŠ˜ë´„ì‹í’ˆ ë°”ë¡œê°€ê¸°
            </button>
            <button onclick="goToShorts()" class="secondary-button" style="margin-top:10px;">
              ğŸ¥ 1ë¶„ ê±´ê°• ìˆì¸  ë³´ëŸ¬ê°€ê¸°
            </button>
            
            <div id="points-insufficient" class="points-notice" style="display: none;">
              í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤ ğŸ˜¢
            </div>
          </div>
        </div>
        <div class="card-grid">
          <div class="info-card">
            <span class="emoji">âœ¨</span>
            <h3>ì‘ì€ ì‹¤ì²œ</h3>
            <p>ì‹¤ì²œí• ìˆ˜ë¡ ìŒ“ì´ëŠ” ìŠµê´€ í¬ì¸íŠ¸<br>ì˜¤ëŠ˜ì˜ ë‚˜ë¥¼ ìœ„í•œ ì‘ì€ íˆ¬ì</p>
          </div>
          <div class="info-card">
            <span class="emoji">ğŸŒ±</span>
            <h3>ê±´ê°•í•œ ë£¨í‹´</h3>
            <p>ì ê¹ì˜ ì—¬ìœ , ë‚˜ë¥¼ ì±™ê¸°ëŠ” ìŠµê´€<br>í•˜ë£¨ í•œ ë²ˆì¯¤, ë‚˜ë¥¼ ìœ„í•œ ì²´í¬íƒ€ì„!</p>
          </div>
          <div class="info-card">
            <span class="emoji">ğŸ</span>
            <h3>ë‚˜ë¥¼ ìœ„í•œ ì„ ë¬¼</h3>
            <p>ê±´ê°• í€´ì¦ˆë¡œ ì•Œì•„ë³´ëŠ” ë‚´ ëª¸ ì‚¬ìš© ì„¤ëª…ì„œ<br>ì•Œë©´ ì§€í‚¤ê²Œ ë˜ëŠ” ê±´ê°• ìƒì‹!</p>
          </div>
        </div>
        <p class="footer-quote">ì‘ì€ ìŠµê´€ì´, ê²°êµ­ ê°€ì¥ ë©€ë¦¬ ê°‘ë‹ˆë‹¤</p>
      </div>
    </div>
    <div class="video-section" id="shorts-section" style="display:none;">
      <h3 class="video-title">ğŸ¥ 1ë¶„ ê±´ê°• ìˆì¸ </h3>
      <ul id="videoList" class="video-list"></ul>
      <button onclick="goBackMain()" class="secondary-button" style="margin-top:20px;">â† ë’¤ë¡œê°€ê¸°</button>
    </div>

    <!-- ëŠ˜ë´„ ìŠµê´€ì‚´ë¡± ë©”ì¸ ì„¹ì…˜ (ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€) -->
    <div id="habit-salon-main" style="display:none;max-width:700px;margin:40px auto 40px auto;padding:0 8px;">
      <!-- ë’¤ë¡œê°€ê¸° ë²„íŠ¼ -->
      <div style="display:flex;justify-content:flex-end;padding:16px 0;margin-bottom:20px;">
        <button id="habit-salon-main-back-btn" style="padding:8px 16px;background:#e0ede3;color:#356c55;border:none;border-radius:8px;font-size:14px;font-weight:600;">â† ë’¤ë¡œê°€ê¸°</button>
      </div>
      
      <!-- ì„¹ì…˜ ë„¤ë¹„ê²Œì´ì…˜ ì¹´ë“œ -->
      <div id="habit-salon-nav-cards" style="display:flex;gap:16px;justify-content:space-between;margin-bottom:32px;flex-wrap:wrap;">
        <div class="habit-salon-nav-card" data-section="brand" style="flex:1 1 140px;min-width:140px;max-width:180px;background:#fff;border-radius:16px;box-shadow:0 2px 8px #e0ede3;padding:18px 10px;display:flex;flex-direction:column;align-items:center;cursor:pointer;transition:box-shadow 0.2s;">
          <img src="assets/img/brand-icon.png" alt="ë¸Œëœë“œ ì´ì•¼ê¸°" style="width:48px;height:48px;margin-bottom:10px;object-fit:contain;"/>
          <div style="font-weight:700;font-size:1.05rem;color:#356c55;">ë¸Œëœë“œ ì´ì•¼ê¸°</div>
        </div>
        <div class="habit-salon-nav-card" data-section="question" style="flex:1 1 140px;min-width:140px;max-width:180px;background:#fff;border-radius:16px;box-shadow:0 2px 8px #e0ede3;padding:18px 10px;display:flex;flex-direction:column;align-items:center;cursor:pointer;transition:box-shadow 0.2s;">
          <img src="assets/img/question-icon%20.png" alt="ì˜¤ëŠ˜ì˜ ì§ˆë¬¸" style="width:48px;height:48px;margin-bottom:10px;object-fit:contain;"/>
          <div style="font-weight:700;font-size:1.05rem;color:#356c55;">ì˜¤ëŠ˜ì˜ ì§ˆë¬¸</div>
        </div>
        <div class="habit-salon-nav-card" data-section="free" style="flex:1 1 140px;min-width:140px;max-width:180px;background:#fff;border-radius:16px;box-shadow:0 2px 8px #e0ede3;padding:18px 10px;display:flex;flex-direction:column;align-items:center;cursor:pointer;transition:box-shadow 0.2s;">
          <img src="assets/img/community-icon.png" alt="ê±´ê°• í•œë§ˆë‹¹" style="width:48px;height:48px;margin-bottom:10px;object-fit:contain;"/>
          <div style="font-weight:700;font-size:1.05rem;color:#356c55;">ê±´ê°• í•œë§ˆë‹¹</div>
        </div>
        <div class="habit-salon-nav-card" data-section="challenge" style="flex:1 1 140px;min-width:140px;max-width:180px;background:#fff;border-radius:16px;box-shadow:0 2px 8px #e0ede3;padding:18px 10px;display:flex;flex-direction:column;align-items:center;cursor:pointer;transition:box-shadow 0.2s;opacity:0.6;">
          <img src="assets/img/challenge-icon.png" alt="ìŠµê´€ ì±Œë¦°ì§€" style="width:48px;height:48px;margin-bottom:10px;object-fit:contain;"/>
          <div style="font-weight:700;font-size:1.05rem;color:#356c55;">ìŠµê´€ ì±Œë¦°ì§€</div>
        </div>
      </div>
      <!-- 1ï¸âƒ£ ë¸Œëœë“œ ì´ì•¼ê¸° -->
      <section id="habit-salon-brand" style="display:none;margin-bottom:40px;">
        <h2 style="font-size:1.3rem;color:#356c55;font-weight:700;">ğŸ“– ë¸Œëœë“œ ì´ì•¼ê¸°</h2>
        <div id="habit-salon-brand-list" style="display:flex;flex-direction:column;gap:20px;padding:12px 0 8px 0;"></div>
      </section>

      <!-- 2ï¸âƒ£ ì˜¤ëŠ˜ì˜ ì§ˆë¬¸ -->
      <section id="habit-salon-question" style="display:none;margin-bottom:40px;">
        <h2 style="font-size:1.3rem;color:#356c55;font-weight:700;">ğŸ“” ì˜¤ëŠ˜ì˜ ì§ˆë¬¸</h2>
        <div id="habit-salon-question-card" style="background:#f8f9fa;padding:20px;border-radius:12px;margin-bottom:12px;"></div>
        <div id="habit-salon-question-comments"></div>
      </section>
      <!-- 3ï¸âƒ£ ê±´ê°• í•œë§ˆë‹¹(ììœ ê¸€) -->
      <section id="habit-salon-free" style="display:none;margin-bottom:40px;position:relative;">
        <h2 style="font-size:1.3rem;color:#356c55;font-weight:700;">ğŸ’¬ ê±´ê°• í•œë§ˆë‹¹</h2>
        <!-- ìµœì‹ /ì¸ê¸°ìˆœ í† ê¸€ -->
        <div id="free-feed-sort-toggle" style="display:flex;gap:8px;justify-content:center;margin-bottom:16px;">
          <button id="sort-latest-btn" class="feed-sort-btn active">ìµœì‹ ìˆœ</button>
          <button id="sort-popular-btn" class="feed-sort-btn">ì¸ê¸°ìˆœ</button>
        </div>
        <div id="habit-salon-free-list"></div>
        <!-- í”Œë¡œíŒ… ê¸€ì“°ê¸° ë²„íŠ¼ (í•­ìƒ ìš°í•˜ë‹¨ ê³ ì •) -->
        <button id="floating-write-btn" class="floating-write-btn" title="ê¸€ì“°ê¸°" onclick="window.openWriteModal()">+</button>
      </section>
      <!-- 4ï¸âƒ£ ìŠµê´€ ì±Œë¦°ì§€(ì˜ˆì •) -->
      <section id="habit-salon-challenge" style="display:none;margin-bottom:40px;">
        <h2 style="font-size:1.3rem;color:#356c55;font-weight:700;">ğŸ¯ ìŠµê´€ ì±Œë¦°ì§€ (ì¤€ë¹„ì¤‘)</h2>
        <div style="background:#f8f9fa;padding:20px;border-radius:12px;">ì£¼ê°„ ì‹¤ì²œ ê³¼ì œ, ë£¨í‹´ ê¸°ë¡ ê¸°ëŠ¥ì´ ê³§ ì˜¤í”ˆë©ë‹ˆë‹¤!</div>
      </section>

      <!-- í¬ì¸íŠ¸ ì •ë³´ ë° ë¡œê·¸ -->
      <div style="text-align:center;margin-top:20px;padding:16px;background:#f8f9fa;border-radius:12px;">
        <p style="margin:0;color:#356c55;font-weight:600;">ğŸ’š í˜„ì¬ í¬ì¸íŠ¸: <span id="habit-salon-my-point">0</span>P</p>
      </div>

      <!-- í”¼ë“œë°± ë©”ì‹œì§€ (ê¸°ì¡´ ë°©ì‹ ëŒ€ì‹  í† ìŠ¤íŠ¸ ì‚¬ìš©) -->
      <div id="habit-salon-feedback" style="display:none;"></div>
    </div>

    <!-- ì „ì²´ í™”ë©´ ë¸Œëœë“œ ì´ì•¼ê¸° í˜ì´ì§€ -->
    <div id="brand-story-fullscreen" class="fullscreen-page">
      <div class="fullscreen-page-header">
        <button class="fullscreen-back-btn" onclick="window.closeBrandStoryPage()">
          â† ë’¤ë¡œê°€ê¸°
        </button>
        <h1 class="fullscreen-page-title">ğŸ“– ë¸Œëœë“œ ì´ì•¼ê¸°</h1>
        <div></div>
      </div>
      <div class="fullscreen-page-content">
        <div class="brand-story-container">
          <div id="brand-story-content"></div>
        </div>
      </div>
    </div>

    <!-- ì „ì²´ í™”ë©´ ì˜¤ëŠ˜ì˜ ì§ˆë¬¸ í˜ì´ì§€ -->
    <div id="question-fullscreen" class="fullscreen-page">
      <div class="fullscreen-page-header">
        <button class="fullscreen-back-btn" onclick="window.closeQuestionPage()">
          â† ë’¤ë¡œê°€ê¸°
        </button>
        <h1 class="fullscreen-page-title">ğŸ“” ì˜¤ëŠ˜ì˜ ì§ˆë¬¸</h1>
        <div></div>
      </div>
      <div class="fullscreen-page-content">
        <div id="question-content"></div>
      </div>
    </div>

    <!-- ì „ì²´ í™”ë©´ ê±´ê°• í•œë§ˆë‹¹(ììœ ê¸€) í˜ì´ì§€ -->
    <!-- free-fullscreen ë“± ì „ì²´í™”ë©´ìš© container ì™„ì „ ì‚­ì œ -->

    <!-- í˜ì´ì§€ ì „í™˜ ì˜¤ë²„ë ˆì´ -->
    <div id="page-transition-overlay" class="page-transition-overlay"></div>

    <!-- ê¸€ì“°ê¸° ëª¨ë‹¬ -->
    <div id="free-write-fullscreen" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header">
          <h2>âœï¸ ê±´ê°• ì´ì•¼ê¸° ì“°ê¸°</h2>
          <button class="modal-close-btn" onclick="window.closeWriteModal()">Ã—</button>
        </div>
        <div class="modal-body">
          <form id="habit-salon-free-form">
            <div class="write-guide">
              <p>ğŸ’¡ 100ì ì´ìƒ ì‘ì„± ì‹œ 100Pê°€ ì ë¦½ë©ë‹ˆë‹¤!</p>
              <ul>
                <li>ì‹¤ì œ ê²½í—˜í•œ ê±´ê°• ê´€ë¦¬ ë°©ë²•</li>
                <li>íš¨ê³¼ë¥¼ ë³¸ ìš´ë™ì´ë‚˜ ì‹ë‹¨</li>
                <li>ë‚˜ë§Œì˜ ê±´ê°• ìŠµê´€ê³¼ ê¿€íŒ</li>
              </ul>
            </div>
            <div class="write-textarea-container">
              <textarea id="habit-salon-free-content" 
                        placeholder="ê±´ê°•ê³¼ ê´€ë ¨ëœ ê²½í—˜ê³¼ ë…¸í•˜ìš°ë¥¼ 100ì ì´ìƒ ì‘ì„±í•´ì£¼ì„¸ìš”."
                        maxlength="500"></textarea>
              <div class="char-counter">0/500</div>
            </div>
            <div class="char-count-guide">ë” ìì„¸í•œ ì´ì•¼ê¸°ë¥¼ ë“¤ë ¤ì£¼ì„¸ìš”! (100ì í•„ìš”)</div>
            <div class="modal-footer">
              <div class="modal-actions">
                <button type="button" class="cancel-btn" onclick="window.closeWriteModal()">ì·¨ì†Œ</button>
                <button type="submit" class="submit-btn" disabled>
                  <span>ê±´ê°• ì´ì•¼ê¸° ê³µìœ í•˜ê¸°</span>
                  <span class="point-badge">+100P</span>
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- í¬ì¸íŠ¸ í‘œì‹œ ì˜ì—­ -->
    <div id="pointsDisplay" class="points-display">
      <span>ë³´ìœ  í¬ì¸íŠ¸: </span>
      <span id="currentPoints">0</span>
      <button id="exchangePointsBtn" class="exchange-points-btn" style="display: none;">
        í¬ì¸íŠ¸ êµí™˜ ì‹ ì²­
      </button>
    </div>

    <!-- í¬ì¸íŠ¸ êµí™˜ ëª¨ë‹¬ -->
    <div id="exchangeModal" class="modal" style="display: none;">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h2>í¬ì¸íŠ¸ êµí™˜ ì‹ ì²­</h2>
        <p>í˜„ì¬ ë³´ìœ  í¬ì¸íŠ¸: <span id="modalCurrentPoints">0</span></p>
        <div class="exchange-form">
          <label for="exchangeAmount">êµí™˜í•  í¬ì¸íŠ¸:</label>
          <input type="number" id="exchangeAmount" min="5000" step="1000">
          <p class="exchange-info">* ìµœì†Œ 5,000í¬ì¸íŠ¸ë¶€í„° êµí™˜ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
          <button id="submitExchange">êµí™˜ ì‹ ì²­</button>
        </div>
      </div>
    </div>

    <!-- ì§„í–‰ ì¤‘ì¸ êµí™˜ ìš”ì²­ ëª©ë¡ -->
    <div id="activeExchangeRequests" class="exchange-requests" style="display: none;">
      <h3>ì§„í–‰ ì¤‘ì¸ êµí™˜ ìš”ì²­</h3>
      <div id="requestsList"></div>
    </div>

  </div>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, getDoc, setDoc, updateDoc, doc, query, where, orderBy, serverTimestamp, deleteDoc, writeBatch, increment, enableNetwork, disableNetwork, connectFirestoreEmulator } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDMgQA6mqaXR_qr9Uyj1-VnC-8qkcj3ZBw",
      authDomain: "neulbom-healt-quiz.firebaseapp.com",
      projectId: "neulbom-healt-quiz",
      storageBucket: "neulbom-healt-quiz.appspot.com",
      messagingSenderId: "300280931247",
      appId: "1:300280931247:web:5516f3bd8e8834304a055a"
    };
    
    console.log('Firebase ì•± ì´ˆê¸°í™” ì¤‘...');
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    // ğŸ”¥ Firestore ì˜¤í”„ë¼ì¸ ì§€ì› í™œì„±í™”
    try {
      // ì˜¤í”„ë¼ì¸ ì§€ì†ì„± í™œì„±í™” (ê¸°ë³¸ê°’ì´ì§€ë§Œ ëª…ì‹œì ìœ¼ë¡œ ì„¤ì •)
      console.log('Firestore ì˜¤í”„ë¼ì¸ ì§€ì› í™œì„±í™” ì¤‘...');
      
      // exchangeRequests ì»¬ë ‰ì…˜ ì´ˆê¸°í™”
      const initializeExchangeRequests = async () => {
        try {
          // ì»¬ë ‰ì…˜ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
          const exchangeRef = collection(db, 'exchangeRequests');
          const snapshot = await getDocs(exchangeRef);
          
          if (snapshot.empty) {
            // ì»¬ë ‰ì…˜ì´ ë¹„ì–´ìˆìœ¼ë©´ ì´ˆê¸° ë¬¸ì„œ ìƒì„±
            await addDoc(collection(db, 'exchangeRequests'), {
              type: 'system',
              createdAt: serverTimestamp(),
              message: 'Collection initialized'
            });
            console.log('exchangeRequests ì»¬ë ‰ì…˜ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
          }
        } catch (error) {
          console.error('exchangeRequests ì»¬ë ‰ì…˜ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
        }
      };

      // ì»¬ë ‰ì…˜ ì´ˆê¸°í™” ì‹¤í–‰
      initializeExchangeRequests();
      
      // ë„¤íŠ¸ì›Œí¬ ìƒíƒœ ê°ì§€
      window.isOnline = navigator.onLine;
      
      window.addEventListener('online', () => {
        console.log('ğŸŒ ë„¤íŠ¸ì›Œí¬ ì—°ê²°ë¨ - Firestore ì¬ì—°ê²° ì‹œë„');
        window.isOnline = true;
        window.showSalonToast('ë„¤íŠ¸ì›Œí¬ê°€ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸŒ', 'success');
        enableNetwork(db).catch(error => {
          console.log('Firestore ë„¤íŠ¸ì›Œí¬ ì¬í™œì„±í™” ì˜¤ë¥˜:', error);
        });
      });
      
      window.addEventListener('offline', () => {
        console.log('ğŸ“´ ë„¤íŠ¸ì›Œí¬ ì—°ê²° ëŠê¹€ - ì˜¤í”„ë¼ì¸ ëª¨ë“œ');
        window.isOnline = false;
        window.showSalonToast('ì˜¤í”„ë¼ì¸ ìƒíƒœì…ë‹ˆë‹¤. ì¼ë¶€ ê¸°ëŠ¥ì´ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'warning');
      });
      
      console.log('ë„¤íŠ¸ì›Œí¬ ìƒíƒœ:', window.isOnline ? 'ì˜¨ë¼ì¸' : 'ì˜¤í”„ë¼ì¸');
      
      } catch (error) {
      console.log('Firestore ì˜¤í”„ë¼ì¸ ì„¤ì • ì˜¤ë¥˜:', error);
    }
    
    console.log('ëŠ˜ë´„ ìŠµê´€ì‚´ë¡± Firebase ì—°ë™ ì™„ë£Œ');

    // ì „ì—­ ë³€ìˆ˜ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ window ê°ì²´ì— í• ë‹¹
    window.db = db;
    
    // ì‚¬ìš©ì ID ê´€ë¦¬ (ê¸°ì¡´ script.jsì™€ í†µì¼)
    window.getUserId = function() {
      let userId = localStorage.getItem('userId');
      if (!userId) {
        userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('userId', userId);
      }
      return userId;
    };

    // ë‹‰ë„¤ì„ ê´€ë¦¬ í•¨ìˆ˜ë“¤
    window.checkNickname = async function() {
      const nickname = localStorage.getItem('nickname');
      const userId = window.getUserId();
      
      if (nickname) {
        // ë‹‰ë„¤ì„ì´ ì´ë¯¸ ìˆìœ¼ë©´ í¼ ìˆ¨ê¸°ê¸°
        const nicknameForm = document.getElementById('nickname-form');
        if (nicknameForm) {
          nicknameForm.style.display = 'none';
        }
        return;
      }

      // Firestoreì—ì„œ ë‹‰ë„¤ì„ í™•ì¸
      try {
        const userDoc = await getDoc(doc(db, 'users', userId));
        if (userDoc.exists() && userDoc.data().nickname) {
          localStorage.setItem('nickname', userDoc.data().nickname);
          const nicknameForm = document.getElementById('nickname-form');
          if (nicknameForm) {
            nicknameForm.style.display = 'none';
          }
        }
      } catch (error) {
        console.error('ë‹‰ë„¤ì„ í™•ì¸ ì˜¤ë¥˜:', error);
      }
    };

    window.registerNickname = async function() {
      const nicknameInput = document.getElementById('nicknameInput');
      const nickname = nicknameInput.value.trim();
      
      if (!nickname) {
        window.showSalonToast('ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
        return;
      }

      try {
        // ì¤‘ë³µ ì²´í¬
        const q = query(collection(db, 'users'), where('nickname', '==', nickname));
        const snapshot = await getDocs(q);
        
        if (!snapshot.empty) {
          window.showSalonToast('ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤.', 'warning');
          return;
        }

        const userId = window.getUserId();
        
        // Firestoreì— ì €ì¥
        await updateDoc(doc(db, 'users', userId), {
          nickname: nickname,
          updatedAt: serverTimestamp()
        });

        // localStorageì— ì €ì¥
        localStorage.setItem('nickname', nickname);
        
        // ì…ë ¥ í¼ ìˆ¨ê¸°ê¸°
        const nicknameForm = document.getElementById('nickname-form');
        if (nicknameForm) {
          nicknameForm.style.display = 'none';
        }

        window.showSalonToast('ë‹‰ë„¤ì„ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰', 'success');
        
      } catch (error) {
        console.error('ë‹‰ë„¤ì„ ë“±ë¡ ì˜¤ë¥˜:', error);
        window.showSalonToast('ë‹‰ë„¤ì„ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
      }
    };

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ë‹‰ë„¤ì„ ì²´í¬
    window.addEventListener('load', function() {
      window.checkNickname();
    });

    // í¬ì¸íŠ¸ ê´€ë¦¬ (ê¸°ì¡´ script.jsì™€ ì—°ë™ + ì˜¤í”„ë¼ì¸ ì§€ì›)
    window.getUserPoints = async function() {
      try {
        // ì˜¤í”„ë¼ì¸ ìƒíƒœ ì²´í¬
        if (!window.isOnline) {
          console.log('ì˜¤í”„ë¼ì¸ ìƒíƒœ - ë¡œì»¬ í¬ì¸íŠ¸ ì‚¬ìš©');
          return parseInt(localStorage.getItem('points') || '0');
        }
        
        // ê¸°ì¡´ script.jsì˜ points ë³€ìˆ˜ì™€ ë™ê¸°í™”
        const localPoints = parseInt(localStorage.getItem('points') || '0');
        
        const userId = window.getUserId();
        const userDoc = await getDoc(doc(db, 'users', userId));
        
        if (userDoc.exists()) {
          const firestorePoints = userDoc.data().points || 0;
          // Firestoreì™€ ë¡œì»¬ í¬ì¸íŠ¸ ì¤‘ ë” í° ê°’ ì‚¬ìš© (ë°ì´í„° ì†ì‹¤ ë°©ì§€)
          const syncedPoints = Math.max(localPoints, firestorePoints);
          
          if (syncedPoints !== firestorePoints) {
            // Firestore ì—…ë°ì´íŠ¸
            await updateDoc(doc(db, 'users', userId), {
              points: syncedPoints,
              lastActive: serverTimestamp()
            });
          }
          
          localStorage.setItem('points', syncedPoints.toString());
          
          // ê¸°ì¡´ script.jsì˜ points ë³€ìˆ˜ë„ ì—…ë°ì´íŠ¸
          if (window.points !== undefined) {
            window.points = syncedPoints;
          }
          
          return syncedPoints;
        } else {
          // ì‚¬ìš©ì ë¬¸ì„œê°€ ì—†ìœ¼ë©´ ìƒì„±
          await setDoc(doc(db, 'users', userId), {
            points: localPoints,
            createdAt: serverTimestamp(),
            lastActive: serverTimestamp()
          });
          return localPoints;
        }
      } catch (error) {
        console.error('í¬ì¸íŠ¸ ì¡°íšŒ ì˜¤ë¥˜:', error);
        console.log('ì˜¤ë¥˜ë¡œ ì¸í•´ ë¡œì»¬ í¬ì¸íŠ¸ ì‚¬ìš©');
        if (error.code === 'failed-precondition' || error.code === 'unavailable') {
          window.showSalonToast('ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.', 'warning');
        }
        return parseInt(localStorage.getItem('points') || '0');
      }
    };
    
    window.addUserPoints = async function(pointsToAdd, source = 'habit_salon', actionId = null) {
      try {
        const userId = window.getUserId();
        
        // ì˜¤í”„ë¼ì¸ ìƒíƒœì—ì„œë„ ë¡œì»¬ í¬ì¸íŠ¸ëŠ” ì—…ë°ì´íŠ¸
        const currentPoints = parseInt(localStorage.getItem('points') || '0');
        const newPoints = Math.max(0, currentPoints + pointsToAdd);
        localStorage.setItem('points', newPoints.toString());
        
        // ê¸°ì¡´ script.jsì˜ points ë³€ìˆ˜ë„ ì—…ë°ì´íŠ¸
        if (window.points !== undefined) {
          window.points = newPoints;
        }
        
        // ì˜¤í”„ë¼ì¸ ìƒíƒœë©´ ë¡œì»¬ë§Œ ì—…ë°ì´íŠ¸í•˜ê³  ë¦¬í„´
        if (!window.isOnline) {
          console.log('ì˜¤í”„ë¼ì¸ ìƒíƒœ - ë¡œì»¬ í¬ì¸íŠ¸ë§Œ ì—…ë°ì´íŠ¸:', newPoints);
          // ì˜¤í”„ë¼ì¸ ì•¡ì…˜ì„ íì— ì €ì¥ (ë‚˜ì¤‘ì— ë™ê¸°í™”ìš©)
          const offlineActions = JSON.parse(localStorage.getItem('offlineActions') || '[]');
          offlineActions.push({
            type: 'addPoints',
            pointsToAdd,
            source,
            actionId,
            timestamp: Date.now()
          });
          localStorage.setItem('offlineActions', JSON.stringify(offlineActions));
          return newPoints;
        }
        
        const userRef = doc(db, 'users', userId);
        
        // ì¤‘ë³µ í¬ì¸íŠ¸ ì§€ê¸‰ ë°©ì§€ (actionIdê°€ ìˆëŠ” ê²½ìš°)
        if (actionId) {
          const duplicateCheck = query(
            collection(db, 'pointsHistory'),
            where('userId', '==', userId),
            where('actionId', '==', actionId)
          );
          const duplicateSnapshot = await getDocs(duplicateCheck);
          
          if (!duplicateSnapshot.empty) {
            console.log('ì´ë¯¸ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ëœ ì•¡ì…˜ì…ë‹ˆë‹¤:', actionId);
            window.showSalonToast('ì´ë¯¸ í¬ì¸íŠ¸ë¥¼ ë°›ì€ í™œë™ì…ë‹ˆë‹¤.', 'warning');
            return await window.getUserPoints();
          }
        }
        
        // Firestoreì—ì„œ í¬ì¸íŠ¸ ì—…ë°ì´íŠ¸
        await updateDoc(userRef, {
          points: newPoints,
          lastActive: serverTimestamp()
        });
        
        // í¬ì¸íŠ¸ ì´ë ¥ì„ pointsHistory ì»¬ë ‰ì…˜ì— ê¸°ë¡
        const historyData = {
          userId: userId,
          points: pointsToAdd,
          action: pointsToAdd > 0 ? 'earn' : 'spend',
          source: source,
          timestamp: serverTimestamp(),
          beforePoints: currentPoints,
          afterPoints: newPoints
        };
        
        if (actionId) {
          historyData.actionId = actionId;
        }
        
        await addDoc(collection(db, 'pointsHistory'), historyData);
        
        // ë©”ì¸ í˜ì´ì§€ í¬ì¸íŠ¸ í‘œì‹œ ì—…ë°ì´íŠ¸
        const mainPointElement = document.getElementById('points');
        if (mainPointElement) {
          mainPointElement.textContent = newPoints;
        }
        
        // ê¸°ì¡´ script.jsì˜ updatePoints í•¨ìˆ˜ í˜¸ì¶œ
        if (typeof updatePoints === 'function') {
          updatePoints();
        }
        
        return newPoints;
      } catch (error) {
        console.error('í¬ì¸íŠ¸ ì¶”ê°€ ì˜¤ë¥˜:', error);
        console.log('ì˜¤ë¥˜ë¡œ ì¸í•´ ë¡œì»¬ í¬ì¸íŠ¸ë§Œ ì—…ë°ì´íŠ¸');
        
        // ì˜¤ë¥˜ ìƒí™©ì—ì„œë„ ë¡œì»¬ í¬ì¸íŠ¸ëŠ” ìœ ì§€
        const currentPoints = parseInt(localStorage.getItem('points') || '0');
        const newPoints = Math.max(0, currentPoints + pointsToAdd);
        localStorage.setItem('points', newPoints.toString());
        
        if (error.code === 'failed-precondition' || error.code === 'unavailable') {
          window.showSalonToast('ë„¤íŠ¸ì›Œí¬ ì—°ê²° ë¬¸ì œë¡œ ë¡œì»¬ì—ë§Œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'warning');
        }
        
        // ê¸°ì¡´ script.jsì˜ addPoints í•¨ìˆ˜ ì‚¬ìš©
        if (typeof addPoints === 'function') {
          addPoints(pointsToAdd);
        }
        
        return newPoints;
      }
    };

    // ë¸Œëœë“œ ê²Œì‹œê¸€ ë¡œë”© (ì¸ë±ìŠ¤ ë¬¸ì œ í•´ê²° - ë‹¨ìˆœ ì¿¼ë¦¬ + í´ë¼ì´ì–¸íŠ¸ í•„í„°ë§)
    window.loadBrandPosts = async function() {
      try {
        console.log('Firebaseì—ì„œ ë¸Œëœë“œ ê²Œì‹œê¸€ ë¡œë”© ì¤‘...');
        
        // ì˜¤í”„ë¼ì¸ ìƒíƒœ ì‹œ ìºì‹œëœ ë°ì´í„° ì‚¬ìš©
        if (!window.isOnline) {
          console.log('ì˜¤í”„ë¼ì¸ ìƒíƒœ - ìºì‹œëœ ë¸Œëœë“œ ê²Œì‹œê¸€ ì‚¬ìš©');
          const cachedData = localStorage.getItem('cached_brand_posts');
          if (cachedData) {
            const posts = JSON.parse(cachedData);
            console.log('ìºì‹œëœ ë¸Œëœë“œ ê²Œì‹œê¸€:', posts.length, 'ê°œ');
            return posts;
          }
          return [{
            id: 'offline_brand_1',
            title: 'ëŠ˜ë´„ê³¼ í•¨ê»˜í•˜ëŠ” ê±´ê°•í•œ ìŠµê´€',
            content: 'ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì´ ë¶ˆì•ˆì •í•©ë‹ˆë‹¤. ì˜¨ë¼ì¸ ìƒíƒœì—ì„œ ë” ë§ì€ ì½˜í…ì¸ ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”.',
            author: 'ëŠ˜ë´„íŒ€',
            timestamp: new Date(),
            likes: 0,
            commentCount: 0,
            isOffline: true
          }];
        }
        
        // Firestoreì—ì„œ ì§ì ‘ í•„í„°ë§í•˜ë„ë¡ ìˆ˜ì •
        const q = query(
          collection(db, 'brand_posts'),
          where('isPublished', '==', true),
          orderBy('timestamp', 'desc')
        );
        const snapshot = await getDocs(q);
        
        const posts = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        
        // ì„±ê³µì ìœ¼ë¡œ ë¡œë”©ë˜ë©´ ìºì‹œì— ì €ì¥
        if (posts.length > 0) {
          localStorage.setItem('cached_brand_posts', JSON.stringify(posts));
          localStorage.setItem('cached_brand_posts_time', Date.now().toString());
        }
        
        console.log('ë¸Œëœë“œ ê²Œì‹œê¸€ ë¡œë”© ì™„ë£Œ:', posts.length, 'ê°œ');
        return posts;
      } catch (error) {
        console.error('ë¸Œëœë“œ ê²Œì‹œê¸€ ë¡œë”© ì˜¤ë¥˜:', error);
        // ì˜¤ë¥˜ ë°œìƒ ì‹œ ìºì‹œëœ ë°ì´í„° ì‚¬ìš© ì‹œë„
        const cachedData = localStorage.getItem('cached_brand_posts');
        if (cachedData) {
          const posts = JSON.parse(cachedData);
          console.log('ì˜¤ë¥˜ ë°œìƒ - ìºì‹œëœ ë¸Œëœë“œ ê²Œì‹œê¸€ ì‚¬ìš©:', posts.length, 'ê°œ');
          return posts;
        }
        return [];
      }
    };
    
    // ê±´ê°• ì§ˆë¬¸ ë¡œë”© (ì¸ë±ìŠ¤ ë¬¸ì œ í•´ê²° - ë‹¨ìˆœ ì¿¼ë¦¬ + í´ë¼ì´ì–¸íŠ¸ í•„í„°ë§)
    window.loadHealthQuestions = async function() {
      try {
        console.log('Firebaseì—ì„œ ê±´ê°• ì§ˆë¬¸ ë¡œë”© ì¤‘...');
        
        // ì˜¤í”„ë¼ì¸ ìƒíƒœ ì‹œ ìºì‹œëœ ë°ì´í„° ì‚¬ìš©
        if (!window.isOnline) {
          console.log('ì˜¤í”„ë¼ì¸ ìƒíƒœ - ìºì‹œëœ ê±´ê°• ì§ˆë¬¸ ì‚¬ìš©');
          const cachedData = localStorage.getItem('cached_health_questions');
          if (cachedData) {
            const questions = JSON.parse(cachedData);
            console.log('ìºì‹œëœ ê±´ê°• ì§ˆë¬¸:', questions.length, 'ê°œ');
            return questions;
          }
          return [{
            id: 'offline_question_1',
            question: 'ì˜¤ëŠ˜ ì¶©ë¶„í•œ ìˆ˜ë¶„ì„ ì„­ì·¨í•˜ì…¨ë‚˜ìš”?',
            options: [
              'ë„¤, ì¶©ë¶„íˆ ë§ˆì…¨ì–´ìš” ğŸ’§',
              'ì ë‹¹íˆ ë§ˆì…¨ì–´ìš” ğŸ¥¤',
              'ë¶€ì¡±í–ˆì–´ìš” ğŸ˜…',
              'ê±°ì˜ ë§ˆì‹œì§€ ì•Šì•˜ì–´ìš” ğŸ’¦'
            ],
            timestamp: new Date(),
            responses: 0,
            isOffline: true
          }];
        }
        
        // Firestoreì—ì„œ ì§ì ‘ í•„í„°ë§í•˜ë„ë¡ ìˆ˜ì •
        const q = query(
          collection(db, 'health_questions'),
          where('isPublished', '==', true),
          orderBy('timestamp', 'desc')
        );
        
        const snapshot = await getDocs(q);
        const questions = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        
        // ì„±ê³µì ìœ¼ë¡œ ë¡œë”©ë˜ë©´ ìºì‹œì— ì €ì¥
        if (questions.length > 0) {
          localStorage.setItem('cached_health_questions', JSON.stringify(questions));
          localStorage.setItem('cached_health_questions_time', Date.now().toString());
        }
        
        console.log('ê±´ê°• ì§ˆë¬¸ ë¡œë”© ì™„ë£Œ:', questions.length, 'ê°œ');
        return questions;
      } catch (error) {
        console.error('ê±´ê°• ì§ˆë¬¸ ë¡œë”© ì˜¤ë¥˜:', error);
        // ì˜¤ë¥˜ ì‹œ ìºì‹œëœ ë°ì´í„° ì‚¬ìš© ì‹œë„
        const cachedData = localStorage.getItem('cached_health_questions');
        if (cachedData) {
          const questions = JSON.parse(cachedData);
          console.log('ì˜¤ë¥˜ ë°œìƒ - ìºì‹œëœ ê±´ê°• ì§ˆë¬¸ ì‚¬ìš©:', questions.length, 'ê°œ');
          return questions;
        }
        return [];
      }
    };
    
    // ì¢‹ì•„ìš” ê¸°ëŠ¥ (Firestore ì—°ë™)
    window.toggleLike = async function(postType, postId) {
      try {
        const userId = window.getUserId();
        const likeId = `${userId}_${postType}_${postId}`;
        const likeRef = doc(db, 'likes', likeId);
        const likeDoc = await getDoc(likeRef);
        
        const postCollection = postType === 'brand' ? 'brand_posts' : 
                              postType === 'question' ? 'health_questions' : 'user_posts';
        const postRef = doc(db, postCollection, postId);
        
        if (likeDoc.exists()) {
          // ì¢‹ì•„ìš” ì·¨ì†Œ
          await deleteDoc(likeRef);
          await updateDoc(postRef, {
            likes: increment(-1)
          });
          localStorage.removeItem(`like_${postType}_${postId}`);
          return false;
        } else {
          // ì¢‹ì•„ìš” ì¶”ê°€
          await setDoc(likeRef, {
            userId: userId,
            postType: postType,
            postId: postId,
            timestamp: serverTimestamp()
          });
          await updateDoc(postRef, {
            likes: increment(1)
          });
          localStorage.setItem(`like_${postType}_${postId}`, 'true');
          return true;
        }
      } catch (error) {
        console.error('ì¢‹ì•„ìš” ì²˜ë¦¬ ì˜¤ë¥˜:', error);
        // ì˜¤ë¥˜ ì‹œ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ë§Œ ì‚¬ìš©
      const likeKey = `like_${postType}_${postId}`;
      const isLiked = localStorage.getItem(likeKey) === 'true';
      
      if (isLiked) {
        localStorage.removeItem(likeKey);
        return false;
      } else {
        localStorage.setItem(likeKey, 'true');
        return true;
        }
      }
    };
    
    window.isLiked = async function(postType, postId) {
      try {
        const userId = window.getUserId();
        const likeId = `${userId}_${postType}_${postId}`;
        const likeDoc = await getDoc(doc(db, 'likes', likeId));
        return likeDoc.exists();
      } catch (error) {
        console.error('ì¢‹ì•„ìš” ìƒíƒœ í™•ì¸ ì˜¤ë¥˜:', error);
      return localStorage.getItem(`like_${postType}_${postId}`) === 'true';
      }
    };

    // í† ìŠ¤íŠ¸ ë©”ì‹œì§€ (ê³ ë„í™”ëœ ë²„ì „)
    window.showSalonToast = function(message, type = 'success') {
      // ê¸°ì¡´ í† ìŠ¤íŠ¸ ì œê±°
      const existingToast = document.querySelector('.salon-toast');
      if (existingToast) {
        existingToast.remove();
      }
      
      const toast = document.createElement('div');
      toast.className = `salon-toast ${type}`;
      
      const icons = {
        success: 'âœ…',
        error: 'âŒ',
        warning: 'âš ï¸',
        info: 'â„¹ï¸'
      };
      
      toast.innerHTML = `
        <div class="salon-toast-content">
          <span class="salon-toast-icon">${icons[type] || icons.success}</span>
          <span class="salon-toast-message">${message}</span>
        </div>
      `;
      
      toast.style.animation = 'toastSlideUp 0.4s ease';
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.style.animation = 'toastSlideDown 0.4s ease';
        setTimeout(() => {
          if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
          }
        }, 400);
      }, 3000);
    };

    // ìŠµê´€ì‚´ë¡± ì´ˆê¸°í™”
    window.initHabitSalon = async function() {
      console.log('ìŠµê´€ì‚´ë¡± ì´ˆê¸°í™” ì‹œì‘');
      
      try {
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì´ˆê¸°í™”
        window.initializeEventListeners();
        
        // í¬ì¸íŠ¸ ë™ê¸°í™”
        const points = await window.getUserPoints();
        const pointDisplay = document.getElementById('habit-salon-my-point');
        if (pointDisplay) {
          pointDisplay.textContent = points;
        }
        
        
        console.log('ìŠµê´€ì‚´ë¡± ì´ˆê¸°í™” ì™„ë£Œ');
      } catch (error) {
        console.error('ìŠµê´€ì‚´ë¡± ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
        window.showSalonToast('ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.', 'error');
      }
    };

    // ìŠµê´€ì‚´ë¡± ì„¹ì…˜ í‘œì‹œ
    window.showHabitSalonSection = async function(sectionName) {
      if (sectionName === 'free') {
        await window.openFreePage();
        return;
      }
      // ê¸°ì¡´ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
      const sections = ['brand', 'question', 'free', 'challenge'];
      sections.forEach(section => {
        const element = document.getElementById(`habit-salon-${section}`);
        if (element) element.style.display = 'none';
      });
      document.getElementById('main-section').style.display = 'none';
      document.getElementById('habit-salon-main').style.display = 'block';
      // ê¸°ì¡´ ì„¹ì…˜ ì§„ì… ë¡œì§
      const targetSection = document.getElementById(`habit-salon-${sectionName}`);
      if (targetSection) {
        targetSection.style.display = 'block';
        if (sectionName === 'brand') await window.loadBrandSection();
        if (sectionName === 'question') await window.loadQuestionSection();
        if (sectionName === 'challenge') {/* ì¤€ë¹„ì¤‘ */}
      }
      // habit-salon-free ì „ì²´í™”ë©´ í•´ì œ
      const freeSection = document.getElementById('habit-salon-free');
      if (freeSection) {
        freeSection.classList.remove('fullscreen');
        freeSection.style.display = 'none';
        // ë’¤ë¡œê°€ê¸°/íƒ€ì´í‹€ ì œê±°
        const backBtn = document.getElementById('free-back-btn');
        if (backBtn) backBtn.remove();
        const title = document.getElementById('free-title');
        if (title) title.remove();
      }
    };

    // ì¹´ë“œ ìŠ¬ë¼ì´ë” ìƒíƒœ ê´€ë¦¬
    let currentCardIndex = 0;
    let currentCards = [];
    let currentSection = '';

    // ë¸Œëœë“œ ì„¹ì…˜ ë¡œë”© (ì¸ìŠ¤íƒ€ ìŠ¤íƒ€ì¼ ì¹´ë“œ)
    window.loadBrandSection = async function() {
      const container = document.getElementById('habit-salon-brand-list');
      if (!container) return;
      
      container.innerHTML = '<div style="text-align:center;padding:40px;color:#666;">ë¡œë”© ì¤‘...</div>';
      
      try {
        const posts = await window.loadBrandPosts();
        
        if (posts.length === 0) {
          container.innerHTML = '<div style="text-align:center;padding:40px;color:#666;">ì˜¤ëŠ˜ì˜ ë¸Œëœë“œ ì´ì•¼ê¸°ê°€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.</div>';
          return;
        }
        
        currentCards = posts;
        currentSection = 'brand';
        currentCardIndex = 0;
        
        container.innerHTML = `
          <div class="card-slider-container">
            <div class="card-slider" id="brand-card-slider">
              ${posts.map((post, index) => `
                <div class="story-card" data-index="${index}">
                  ${post.imageUrl ? `<img src="${post.imageUrl}" alt="ë¸Œëœë“œ ì´ë¯¸ì§€" class="story-card-image">` : 
                    '<div class="story-card-image" style="display:flex;align-items:center;justify-content:center;font-size:48px;">ğŸŒ¿</div>'}
                  <div class="story-card-content">
                    <h3 class="story-card-title">${post.title || 'ëŠ˜ë´„ ë¸Œëœë“œ ì´ì•¼ê¸°'}</h3>
                    <p class="story-card-text">${post.content}</p>
                    <div class="story-card-meta">
                      <div class="story-card-author">
                        <div class="story-card-avatar">ëŠ˜</div>
                        <div class="story-card-author-info">
                          <div class="story-card-author-name">${post.author || 'ëŠ˜ë´„íŒ€'}</div>
                          <div class="story-card-time">${window.formatTime(post.timestamp)}</div>
                        </div>
                      </div>
                      <div class="story-card-actions">
                        <button class="story-action-btn" onclick="window.toggleStoryLike('brand', '${post.id}', ${index})">
                          <span id="like-icon-brand-${index}">â¤ï¸</span>
                          <span id="like-count-brand-${index}">${post.likes || 0}</span>
                        </button>
                        <button class="story-action-btn comment-btn" onclick="window.toggleStoryComments('brand', '${post.id}', ${index})">
                          <span>ğŸ’¬</span>
                          <span id="comment-count-brand-${index}">${post.commentCount || 0}</span>
                        </button>
                      </div>
                    </div>
                  </div>
                  <div class="story-comments-section active" id="comments-brand-${index}">
                    <div class="story-comments-header">
                      ëŒ“ê¸€ <span id="comment-header-count-brand-${index}">${post.commentCount || 0}</span>ê°œ
                    </div>
                    <div class="story-comments-list" id="comment-list-brand-${index}">
                      <!-- ëŒ“ê¸€ ëª©ë¡ì´ ì—¬ê¸°ì— ë¡œë“œë©ë‹ˆë‹¤ -->
                    </div>
                    <div class="story-comment-input">
                      <div class="story-comment-form">
                        <textarea id="comment-input-brand-${index}" class="story-comment-textarea" 
                                  placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”... (+30P)" maxlength="200"></textarea>
                        <button onclick="window.submitStoryComment('brand', '${post.id}', ${index})" 
                                class="story-comment-submit">ë“±ë¡</button>
                      </div>
                    </div>
                  </div>
                </div>
              `).join('')}
            </div>
            ${posts.length > 1 ? `
              <button class="card-nav prev" onclick="window.prevCard()" id="prev-btn">â€¹</button>
              <button class="card-nav next" onclick="window.nextCard()" id="next-btn">â€º</button>
            ` : ''}
          </div>
          ${posts.length > 1 ? `
            <div class="card-indicators">
              ${posts.map((_, index) => `
                <div class="card-indicator ${index === 0 ? 'active' : ''}" 
                     onclick="window.goToCard(${index})" data-index="${index}"></div>
              `).join('')}
            </div>
          ` : ''}
        `;
        
        window.updateCardNavigation();
        
      } catch (error) {
        console.error('ë¸Œëœë“œ ì„¹ì…˜ ë¡œë”© ì˜¤ë¥˜:', error);
        container.innerHTML = '<div style="text-align:center;padding:40px;color:#f44336;">ë¡œë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
      }
    };

    // ì§ˆë¬¸ ì„¹ì…˜ ë¡œë”© (ì¸ìŠ¤íƒ€ ìŠ¤íƒ€ì¼ ì¹´ë“œ)
    window.loadQuestionSection = async function() {
      const container = document.getElementById('habit-salon-question-card');
      const commentsContainer = document.getElementById('habit-salon-question-comments');
      
      if (!container) return;
      
      container.innerHTML = '<div style="text-align:center;padding:40px;color:#666;">ë¡œë”© ì¤‘...</div>';
      
      try {
        const questions = await window.loadHealthQuestions();
        
        if (questions.length === 0) {
          container.innerHTML = '<div style="text-align:center;padding:40px;color:#666;">ì˜¤ëŠ˜ì˜ ì§ˆë¬¸ì´ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.</div>';
          return;
        }
        
        currentCards = questions;
        currentSection = 'question';
        currentCardIndex = 0;
        
        container.innerHTML = `
          <div class="card-slider-container">
            <div class="card-slider" id="question-card-slider">
              ${questions.map((question, index) => `
                <div class="story-card question-card" data-index="${index}">
                  <div class="story-card-content">
                    <h3 class="story-card-title">ğŸ“ ${question.question}</h3>
                    <div class="question-options">
                      ${question.options ? question.options.map((option, optionIndex) => `
                        <button class="question-option" 
                                onclick="window.answerStoryQuestion('${question.id}', ${optionIndex}, ${index})"
                                id="option-${index}-${optionIndex}">
                          ${option}
                        </button>
                      `).join('') : ''}
                    </div>
                    <div class="question-reward">ğŸ’¡ ë‹µë³€í•˜ë©´ 30Pê°€ ì ë¦½ë©ë‹ˆë‹¤!</div>
                  </div>
                  <div class="story-comments-section active" id="comments-question-${index}">
                    <div class="story-comments-header">
                      ëŒ“ê¸€ <span id="comment-header-count-question-${index}">${question.commentCount || 0}</span>ê°œ
                    </div>
                    <div class="story-comments-list" id="comment-list-question-${index}">
                      <!-- ëŒ“ê¸€ ëª©ë¡ì´ ì—¬ê¸°ì— ë¡œë“œë©ë‹ˆë‹¤ -->
                    </div>
                    <div class="story-comment-input">
                      <div class="story-comment-form">
                        <textarea id="comment-input-question-${index}" class="story-comment-textarea" 
                                  placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”... (+30P)" maxlength="200"></textarea>
                        <button onclick="window.submitStoryComment('question', '${question.id}', ${index})" 
                                class="story-comment-submit">ë“±ë¡</button>
                      </div>
                    </div>
                  </div>
                </div>
              `).join('')}
            </div>
            ${questions.length > 1 ? `
              <button class="card-nav prev" onclick="window.prevCard()" id="prev-btn">â€¹</button>
              <button class="card-nav next" onclick="window.nextCard()" id="next-btn">â€º</button>
            ` : ''}
          </div>
          ${questions.length > 1 ? `
            <div class="card-indicators">
              ${questions.map((_, index) => `
                <div class="card-indicator ${index === 0 ? 'active' : ''}" 
                     onclick="window.goToCard(${index})" data-index="${index}"></div>
              `).join('')}
            </div>
          ` : ''}
        `;
        
        if (commentsContainer) {
          commentsContainer.innerHTML = '';
        }
        
        window.updateCardNavigation();
        
      } catch (error) {
        console.error('ì§ˆë¬¸ ì„¹ì…˜ ë¡œë”© ì˜¤ë¥˜:', error);
        container.innerHTML = '<div style="text-align:center;padding:40px;color:#f44336;">ë¡œë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
      }
    };

    // ììœ  ì„¹ì…˜ ë¡œë”© (ì¹´ë“œí˜• ë¦¬ìŠ¤íŠ¸ í”¼ë“œ)
    window.loadFreeSection = async function() {
      const container = document.getElementById('habit-salon-free-list');
      if (!container) return;
      container.innerHTML = '<div style="text-align:center;padding:40px;color:#666;">ë¡œë”© ì¤‘...</div>';
      try {
        let posts = await window.loadUserPosts();
        // ì •ë ¬
        const sortLatestBtn = document.getElementById('sort-latest-btn');
        const sortPopularBtn = document.getElementById('sort-popular-btn');
        if (sortLatestBtn && sortPopularBtn) {
          sortLatestBtn.onclick = () => {
            sortLatestBtn.classList.add('active');
            sortPopularBtn.classList.remove('active');
            posts.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
            renderFeed();
          };
          sortPopularBtn.onclick = () => {
            sortPopularBtn.classList.add('active');
            sortLatestBtn.classList.remove('active');
            posts.sort((a, b) => (b.likes || 0) - (a.likes || 0));
            renderFeed();
          };
        }
        // ê¸°ë³¸ ìµœì‹ ìˆœ
        posts.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
        function renderFeed() {
          if (posts.length === 0) {
            container.innerHTML = '<div style="text-align:center;padding:40px;color:#666;">ì²« ë²ˆì§¸ ê±´ê°• ì´ì•¼ê¸°ë¥¼ ë‚¨ê²¨ë³´ì„¸ìš”!</div>';
            return;
          }
          container.innerHTML = posts.map((post, index) => `
            <div class="feed-card" style="margin-bottom:24px;">
              <div class="feed-card-header" style="display:flex;justify-content:space-between;align-items:center;">
                <span class="feed-card-author" style="font-weight:600;color:#356c55;">${post.nickname || 'ìµëª…'}</span>
                <span class="feed-card-time" style="font-size:13px;color:#999;">${window.formatTime(post.timestamp)}</span>
              </div>
              <div class="feed-card-content" style="margin:16px 0;">
                <div class="feed-card-text" id="feed-card-text-${index}" style="font-size:16px;color:#333;line-height:1.7;max-height:72px;overflow:hidden;position:relative;">${post.content.length > 100 ? post.content.slice(0, 100) + '...' : post.content}</div>
                ${post.content.length > 100 ? `<button class="feed-card-more-btn" onclick="window.toggleFeedMore(${index})" style="background:none;border:none;color:#4CAF50;font-size:14px;cursor:pointer;">ë”ë³´ê¸°</button>` : ''}
              </div>
              <div class="feed-card-actions" style="display:flex;gap:16px;align-items:center;">
                <button class="feed-card-like-btn" onclick="window.toggleStoryLike('free', '${post.id}', ${index})" style="background:none;border:none;cursor:pointer;font-size:15px;display:flex;align-items:center;gap:4px;">
                  <span id="like-icon-free-${index}">${post.isLiked ? 'â¤ï¸' : 'ğŸ¤'}</span>
                  <span id="like-count-free-${index}">${post.likes || 0}</span>
                </button>
                <button class="feed-card-comment-btn" onclick="window.toggleFeedComments(${index})" style="background:none;border:none;cursor:pointer;font-size:15px;display:flex;align-items:center;gap:4px;">
                  ğŸ’¬ <span id="comment-count-free-${index}">${post.commentCount || 0}</span>
                </button>
              </div>
              <div class="feed-card-comments" id="feed-card-comments-${index}" style="display:none;margin-top:12px;background:#fafbfc;border-radius:12px;padding:12px 8px;">
                <div class="story-comments-list" id="comment-list-free-${index}"></div>
                <div class="story-comment-input" style="margin-top:8px;">
                  <div class="story-comment-form" style="display:flex;gap:8px;align-items:flex-end;">
                    <textarea id="comment-input-free-${index}" class="story-comment-textarea" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”... (+30P)" maxlength="200" style="flex:1;padding:10px 14px;border-radius:16px;border:1px solid #e0e0e0;font-size:14px;"></textarea>
                    <button onclick="window.submitStoryComment('free', '${post.id}', ${index})" class="story-comment-submit" style="padding:10px 16px;background:#356c55;color:white;border:none;border-radius:16px;font-size:14px;font-weight:600;cursor:pointer;">ë“±ë¡</button>
                  </div>
                </div>
              </div>
            </div>
          `).join('');
        }
        // ë”ë³´ê¸°/í¼ì¹˜ê¸° í† ê¸€ í•¨ìˆ˜
        window.toggleFeedMore = function(index) {
          const textDiv = document.getElementById(`feed-card-text-${index}`);
          if (!textDiv) return;
          if (textDiv.style.maxHeight === 'none') {
            textDiv.style.maxHeight = '72px';
            textDiv.style.overflow = 'hidden';
          } else {
            textDiv.style.maxHeight = 'none';
            textDiv.style.overflow = 'visible';
          }
        };
        // ëŒ“ê¸€ì°½ í† ê¸€ í•¨ìˆ˜
        window.toggleFeedComments = async function(index) {
          const commentsDiv = document.getElementById(`feed-card-comments-${index}`);
          if (!commentsDiv) return;
          if (commentsDiv.style.display === 'block') {
            commentsDiv.style.display = 'none';
          } else {
            commentsDiv.style.display = 'block';
            // ëŒ“ê¸€ ëª©ë¡ ë¡œë“œ
            const post = posts[index];
            await window.loadStoryComments('free', post.id, index);
          }
        };
        renderFeed();
      } catch (error) {
        console.error('í”¼ë“œ ë¡œë”© ì˜¤ë¥˜:', error);
        container.innerHTML = '<div style="text-align:center;padding:40px;color:#f44336;">ë¡œë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
      }
    };

    // ììœ ê¸€ ì‘ì„± ì²˜ë¦¬
    window.handleFreePostSubmit = async function(e) {
      e.preventDefault();
      
      const textarea = document.getElementById('habit-salon-free-content');
      const content = textarea.value.trim();
      
      if (content.length < 50) {
        window.showSalonToast('50ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
        return;
      }
      
      try {
        const submitBtn = e.target.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.textContent = 'ì‘ì„± ì¤‘...';
        
        await window.addUserPost(content);
        
        textarea.value = '';
        window.showSalonToast('ììœ ê¸€ì´ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤! +100P ì ë¦½ ğŸ‰');
        
        // í¬ì¸íŠ¸ í‘œì‹œ ì—…ë°ì´íŠ¸
        const points = await window.getUserPoints();
        const pointDisplay = document.getElementById('habit-salon-my-point');
        if (pointDisplay) {
          pointDisplay.textContent = points;
        }
        
        // ììœ  ì„¹ì…˜ ìƒˆë¡œê³ ì¹¨
        await window.loadFreeSection();
        
      } catch (error) {
        console.error('ììœ ê¸€ ì‘ì„± ì˜¤ë¥˜:', error);
        window.showSalonToast('ì‘ì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
      } finally {
        const submitBtn = e.target.querySelector('button[type="submit"]');
        submitBtn.disabled = false;
        submitBtn.textContent = 'ììœ ê¸€ ì‘ì„± (+100P)';
      }
    };

    // ëŒ“ê¸€ í† ê¸€
    window.toggleComments = async function(postType, postId) {
      console.log('ëŒ“ê¸€ í† ê¸€:', { postType, postId });
      
      const commentsSection = document.getElementById(`comments-${postType}-${postId}`);
      if (!commentsSection) {
        console.error('ëŒ“ê¸€ ì„¹ì…˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      const isVisible = commentsSection.classList.contains('active');
      
      if (!isVisible) {
        // ëŒ“ê¸€ ì„¹ì…˜ í‘œì‹œ
        commentsSection.classList.add('active');
        
        // ëŒ“ê¸€ ëª©ë¡ ë¡œë“œ
        await window.loadStoryComments(postType, postId);
        
        // ì…ë ¥ì°½ì— í¬ì»¤ìŠ¤
        const input = document.getElementById(`comment-input-${postType}-${postId}`);
        if (input) {
          input.focus();
        }
      } else {
        // ëŒ“ê¸€ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
        commentsSection.classList.remove('active');
      }
    };

    // ëŒ“ê¸€ ë¡œë”©
    window.loadComments = async function(postType, postId) {
      const container = document.getElementById(`comment-list-${postType}-${postId}`);
      if (!container) return;
      
      try {
        const comments = await window.getComments(postType, postId);
        
        container.innerHTML = comments.map(comment => `
          <div class="feed-comment">
            <div class="feed-comment-avatar">${comment.author.charAt(0)}</div>
            <div class="feed-comment-content">
              <div class="feed-comment-header">
                <span class="feed-comment-author">${comment.author}</span>
                <span class="feed-comment-time">${window.formatTime(comment.timestamp)}</span>
              </div>
              <div class="feed-comment-text">${comment.content}</div>
            </div>
          </div>
        `).join('');
        
      } catch (error) {
        console.error('ëŒ“ê¸€ ë¡œë”© ì˜¤ë¥˜:', error);
        container.innerHTML = '<div style="color:#f44336;padding:10px;">ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
      }
    };

    // ëŒ“ê¸€ ì‘ì„±
    window.submitComment = async function(postType, postId) {
      const input = document.getElementById(`comment-input-${postType}-${postId}`);
      const content = input.value.trim();
      
      if (!content) {
        window.showSalonToast('ëŒ“ê¸€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
        return;
      }
      
      if (content.length > 200) {
        window.showSalonToast('ëŒ“ê¸€ì€ 200ì ì´í•˜ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
        return;
      }
      
      try {
        const submitBtn = input.nextElementSibling;
        submitBtn.disabled = true;
        submitBtn.textContent = 'ë“±ë¡ ì¤‘...';
        
        await window.addComment(postType, postId, content);
        
        input.value = '';
        const charCount = document.getElementById(`char-count-${postType}-${postId}`);
        if (charCount) charCount.textContent = '0/200';
        
        window.showSalonToast('ëŒ“ê¸€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤! +50P ì ë¦½ ğŸ‰');
        
        // í¬ì¸íŠ¸ í‘œì‹œ ì—…ë°ì´íŠ¸
        const points = await window.getUserPoints();
        const pointDisplay = document.getElementById('habit-salon-my-point');
        if (pointDisplay) {
          pointDisplay.textContent = points;
        }
        
        // ëŒ“ê¸€ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        await window.loadComments(postType, postId);
        
        // ëŒ“ê¸€ ìˆ˜ ì—…ë°ì´íŠ¸
        const countElement = document.getElementById(`comment-count-${postType}-${postId}`);
        if (countElement) {
          const currentCount = parseInt(countElement.textContent) || 0;
          countElement.textContent = currentCount + 1;
          countElement.classList.add('comment-count-update');
          setTimeout(() => {
            countElement.classList.remove('comment-count-update');
          }, 300);
        }
        
      } catch (error) {
        console.error('ëŒ“ê¸€ ì‘ì„± ì˜¤ë¥˜:', error);
        window.showSalonToast('ëŒ“ê¸€ ì‘ì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
      } finally {
        const submitBtn = input.nextElementSibling;
        submitBtn.disabled = false;
        submitBtn.textContent = 'ë“±ë¡';
      }
    };

    // ì¢‹ì•„ìš” í† ê¸€
    window.togglePostLike = async function(postType, postId) {
      try {
        const isLiked = await window.toggleLike(postType, postId);
        const likeElement = document.getElementById(`likes-${postType}-${postId}`);
        
        if (likeElement) {
          const currentLikes = parseInt(likeElement.textContent) || 0;
          likeElement.textContent = isLiked ? currentLikes + 1 : Math.max(0, currentLikes - 1);
        }
        
        window.showSalonToast(isLiked ? 'ì¢‹ì•„ìš”! â¤ï¸' : 'ì¢‹ì•„ìš” ì·¨ì†Œ');
        
      } catch (error) {
        console.error('ì¢‹ì•„ìš” ì²˜ë¦¬ ì˜¤ë¥˜:', error);
        window.showSalonToast('ì¢‹ì•„ìš” ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
      }
    };

    // ì§ˆë¬¸ ë‹µë³€
    window.answerQuestion = async function(questionId, optionIndex) {
      try {
        // ë‹µë³€ ê¸°ë¡
        await addDoc(collection(db, 'question_answers'), {
          questionId: questionId,
          optionIndex: optionIndex,
          userId: window.getUserId(),
          timestamp: serverTimestamp()
        });
        
        // í¬ì¸íŠ¸ ì§€ê¸‰
        await window.addUserPoints(30);
        
        window.showSalonToast('ë‹µë³€ ì™„ë£Œ! +30P ì ë¦½ ğŸ‰');
        
        // í¬ì¸íŠ¸ í‘œì‹œ ì—…ë°ì´íŠ¸
        const points = await window.getUserPoints();
        const pointDisplay = document.getElementById('habit-salon-my-point');
        if (pointDisplay) {
          pointDisplay.textContent = points;
        }
        
        // ë²„íŠ¼ ë¹„í™œì„±í™”
        const buttons = document.querySelectorAll(`button[onclick*="${questionId}"]`);
        buttons.forEach(btn => {
          btn.disabled = true;
          btn.style.opacity = '0.6';
        });
        
      } catch (error) {
        console.error('ì§ˆë¬¸ ë‹µë³€ ì˜¤ë¥˜:', error);
        window.showSalonToast('ë‹µë³€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
      }
    };

    // ì‹œê°„ í¬ë§·íŒ…
    window.formatTime = function(timestamp) {
      if (!timestamp) return 'ë°©ê¸ˆ ì „';
      
      const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
      const now = new Date();
      const diff = now - date;
      
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);
      
      if (minutes < 1) return 'ë°©ê¸ˆ ì „';
      if (minutes < 60) return `${minutes}ë¶„ ì „`;
      if (hours < 24) return `${hours}ì‹œê°„ ì „`;
      if (days < 7) return `${days}ì¼ ì „`;
      
      return date.toLocaleDateString();
    };

    console.log('ëŠ˜ë´„ ìŠµê´€ì‚´ë¡± ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì™„ë£Œ');
    console.log('ì‚¬ìš©ì ID:', window.getUserId());
    
    // ì¹´ë“œ ìŠ¬ë¼ì´ë” ë„¤ë¹„ê²Œì´ì…˜ í•¨ìˆ˜ë“¤
    window.updateCardNavigation = function() {
      const prevBtn = document.getElementById('prev-btn');
      const nextBtn = document.getElementById('next-btn');
      const indicators = document.querySelectorAll('.card-indicator');
      
      if (prevBtn) {
        prevBtn.disabled = currentCardIndex === 0;
        prevBtn.style.opacity = currentCardIndex === 0 ? '0.3' : '1';
      }
      
      if (nextBtn) {
        nextBtn.disabled = currentCardIndex === currentCards.length - 1;
        nextBtn.style.opacity = currentCardIndex === currentCards.length - 1 ? '0.3' : '1';
      }
      
      // ì¸ë””ì¼€ì´í„° ì—…ë°ì´íŠ¸
      indicators.forEach((indicator, index) => {
        indicator.classList.toggle('active', index === currentCardIndex);
      });
      
      // ìŠ¬ë¼ì´ë” ìœ„ì¹˜ ì—…ë°ì´íŠ¸
      const sliders = document.querySelectorAll('.card-slider');
      sliders.forEach(slider => {
        slider.style.transform = `translateX(-${currentCardIndex * 100}%)`;
      });
    };
    
    window.prevCard = function() {
      if (currentCardIndex > 0) {
        currentCardIndex--;
        window.updateCardNavigation();
      }
    };
    
    window.nextCard = function() {
      if (currentCardIndex < currentCards.length - 1) {
        currentCardIndex++;
        window.updateCardNavigation();
      }
    };
    
    window.goToCard = function(index) {
      if (index >= 0 && index < currentCards.length) {
        currentCardIndex = index;
        window.updateCardNavigation();
      }
    };
    
    // ìŠ¤í† ë¦¬ ì¢‹ì•„ìš” í† ê¸€
    window.toggleStoryLike = async function(postType, postId, cardIndex) {
      try {
        const isLiked = await window.toggleLike(postType, postId);
        const likeIcon = document.getElementById(`like-icon-${postType}-${cardIndex}`);
        const likeCount = document.getElementById(`like-count-${postType}-${cardIndex}`);
        
        if (likeIcon) {
          likeIcon.textContent = isLiked ? 'â¤ï¸' : 'ğŸ¤';
          likeIcon.style.color = isLiked ? '#e74c3c' : '#666';
        }
        
        if (likeCount) {
          const currentLikes = parseInt(likeCount.textContent) || 0;
          likeCount.textContent = isLiked ? currentLikes + 1 : Math.max(0, currentLikes - 1);
        }
        
        window.showSalonToast(isLiked ? 'ì¢‹ì•„ìš”! â¤ï¸' : 'ì¢‹ì•„ìš” ì·¨ì†Œ');
        
      } catch (error) {
        console.error('ì¢‹ì•„ìš” ì²˜ë¦¬ ì˜¤ë¥˜:', error);
        window.showSalonToast('ì¢‹ì•„ìš” ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
      }
    };
    
    // ìŠ¤í† ë¦¬ ëŒ“ê¸€ í† ê¸€
    window.toggleStoryComments = async function(postType, postId, cardIndex) {
      const commentsSection = document.getElementById(`comments-${postType}-${cardIndex}`);
      if (!commentsSection) return;
      
      if (commentsSection.classList.contains('active')) {
        commentsSection.classList.remove('active');
      } else {
        commentsSection.classList.add('active');
        await window.loadStoryComments(postType, postId, cardIndex);
      }
    };
    
    // ìŠ¤í† ë¦¬ ëŒ“ê¸€ ë¡œë”©
    window.loadStoryComments = async function(postType, postId, cardIndex) {
      console.log('ëŒ“ê¸€ ëª©ë¡ ë¡œë“œ ì‹œë„:', { postType, postId, cardIndex });
      const container = document.getElementById(`comment-list-${postType}-${cardIndex}`);
      if (!container) {
        console.error('ëŒ“ê¸€ ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', `comment-list-${postType}-${cardIndex}`);
        return;
      }
      
      try {
        const comments = await window.getComments(postType, postId);
        console.log('ë¡œë“œëœ ëŒ“ê¸€:', comments);
        
        if (comments.length === 0) {
          container.innerHTML = '<div style="text-align:center;padding:20px;color:#666;">ì²« ë²ˆì§¸ ëŒ“ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”!</div>';
          return;
        }
        
        container.innerHTML = comments.map(comment => `
          <div class="story-comment">
            <div class="story-comment-header">
              <div class="story-comment-author">
                <div class="story-comment-avatar">${comment.nickname ? comment.nickname[0] : 'ìµ'}</div>
                <div class="story-comment-info">
                  <div class="story-comment-name">${comment.nickname || 'ìµëª…'}</div>
                  <div class="story-comment-time">${window.formatTime(comment.timestamp)}</div>
                </div>
              </div>
            </div>
            <div class="story-comment-text">${comment.text || comment.content}</div>
          </div>
        `).join('');
        
      } catch (error) {
        console.error('ëŒ“ê¸€ ë¡œë”© ì˜¤ë¥˜:', error);
        container.innerHTML = '<div style="color:#f44336;padding:10px;">ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
      }
    };
    
    // ìŠ¤í† ë¦¬ ëŒ“ê¸€ ì‘ì„±
    window.submitStoryComment = async function(postType, postId, cardIndex) {
      const input = document.getElementById(`comment-input-${postType}-${cardIndex}`);
      if (!input) {
        console.error('ëŒ“ê¸€ ì…ë ¥ì°½ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      const content = input.value.trim();
      
      if (!content) {
        window.showSalonToast('ëŒ“ê¸€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
        return;
      }
      
      if (content.length > 200) {
        window.showSalonToast('ëŒ“ê¸€ì€ 200ì ì´í•˜ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
        return;
      }
      
      try {
        const submitBtn = input.parentNode.querySelector('.story-comment-submit');
        if (submitBtn) {
          submitBtn.disabled = true;
          submitBtn.textContent = 'ë“±ë¡ ì¤‘...';
        }
        
        // ëŒ“ê¸€ ì¶”ê°€ (í¬ì¸íŠ¸ëŠ” addComment ì•ˆì—ì„œ ì²˜ë¦¬)
        await window.addComment(postType, postId, content);
        
        input.value = '';
        window.showSalonToast('ëŒ“ê¸€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤! +30P ì ë¦½ ğŸ‰');
        
        // í¬ì¸íŠ¸ í‘œì‹œ ì—…ë°ì´íŠ¸
        const points = await window.getUserPoints();
        const pointDisplay = document.getElementById('habit-salon-my-point');
        if (pointDisplay) {
          pointDisplay.textContent = points;
        }
        
        // ëŒ“ê¸€ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        await window.loadStoryComments(postType, postId, cardIndex);
        
        // ëŒ“ê¸€ ìˆ˜ ì—…ë°ì´íŠ¸
        const countElements = [
          document.getElementById(`comment-count-${postType}-${cardIndex}`),
          document.getElementById(`comment-header-count-${postType}-${cardIndex}`)
        ];
        
        countElements.forEach(countElement => {
          if (countElement) {
            const currentCount = parseInt(countElement.textContent) || 0;
            countElement.textContent = currentCount + 1;
            countElement.classList.add('comment-count-update');
            setTimeout(() => {
              countElement.classList.remove('comment-count-update');
            }, 300);
          }
        });
        
      } catch (error) {
        console.error('ëŒ“ê¸€ ì‘ì„± ì˜¤ë¥˜:', error);
        window.showSalonToast('ëŒ“ê¸€ ì‘ì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
      } finally {
        const submitBtn = input.parentNode.querySelector('.story-comment-submit');
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = 'ë“±ë¡';
        }
      }
    };
    
    // ìŠ¤í† ë¦¬ ì§ˆë¬¸ ë‹µë³€
    window.answerStoryQuestion = async function(questionId, optionIndex, cardIndex) {
      try {
        // ì¤‘ë³µ ë‹µë³€ ë°©ì§€
        const answerId = `answer_${questionId}_${window.getUserId()}`;
        const existingAnswer = localStorage.getItem(answerId);
        
        if (existingAnswer) {
          window.showSalonToast('ì´ë¯¸ ë‹µë³€í•œ ì§ˆë¬¸ì…ë‹ˆë‹¤.', 'warning');
          return;
        }
        
        // ë‹µë³€ ê¸°ë¡
        await addDoc(collection(db, 'question_answers'), {
          questionId: questionId,
          optionIndex: optionIndex,
          userId: window.getUserId(),
          timestamp: serverTimestamp()
        });
        
        // ì¤‘ë³µ ë‹µë³€ ë°©ì§€ìš© ë¡œì»¬ ì €ì¥
        localStorage.setItem(answerId, 'true');
        
        // í¬ì¸íŠ¸ ì§€ê¸‰
        await window.addUserPoints(30, 'question_answer', answerId);
        
        window.showSalonToast('ë‹µë³€ ì™„ë£Œ! +30P ì ë¦½ ğŸ‰');
        
        // í¬ì¸íŠ¸ í‘œì‹œ ì—…ë°ì´íŠ¸
        const points = await window.getUserPoints();
        const pointDisplay = document.getElementById('habit-salon-my-point');
        if (pointDisplay) {
          pointDisplay.textContent = points;
        }
        
        // ë²„íŠ¼ë“¤ ë¹„í™œì„±í™”
        const optionButtons = document.querySelectorAll(`#option-${cardIndex}-0, #option-${cardIndex}-1, #option-${cardIndex}-2, #option-${cardIndex}-3`);
        optionButtons.forEach(btn => {
          btn.disabled = true;
          btn.style.opacity = '0.6';
          btn.style.cursor = 'not-allowed';
        });
        
        // ì„ íƒí•œ ì˜µì…˜ í•˜ì´ë¼ì´íŠ¸
        const selectedOption = document.getElementById(`option-${cardIndex}-${optionIndex}`);
        if (selectedOption) {
          selectedOption.style.background = 'rgba(255,255,255,0.3)';
          selectedOption.style.borderColor = 'rgba(255,255,255,0.6)';
        }
        
      } catch (error) {
        console.error('ì§ˆë¬¸ ë‹µë³€ ì˜¤ë¥˜:', error);
        window.showSalonToast('ë‹µë³€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
      }
    };
    
    // ëª¨ë°”ì¼ ìŠ¤ì™€ì´í”„ ì§€ì›
    let startX = 0;
    let isDragging = false;
    
    document.addEventListener('touchstart', function(e) {
      if (e.target.closest('.card-slider-container')) {
        startX = e.touches[0].clientX;
        isDragging = true;
      }
    });
    
    document.addEventListener('touchend', function(e) {
      if (!isDragging) return;
      isDragging = false;
      
      if (e.target.closest('.card-slider-container')) {
        const endX = e.changedTouches[0].clientX;
        const diffX = startX - endX;
        
        if (Math.abs(diffX) > 50) { // 50px ì´ìƒ ìŠ¤ì™€ì´í”„
          if (diffX > 0) {
            // ì™¼ìª½ ìŠ¤ì™€ì´í”„ (ë‹¤ìŒ ì¹´ë“œ)
            window.nextCard();
          } else {
            // ì˜¤ë¥¸ìª½ ìŠ¤ì™€ì´í”„ (ì´ì „ ì¹´ë“œ)
            window.prevCard();
          }
        }
      }
    });
    
    console.log('ğŸ’¡ ì‹¤ì œ ìš´ì˜ ë°°í¬ ì‹œì—ëŠ” Firebase ì½˜ì†”ì—ì„œ ì§ì ‘ ë°ì´í„°ë¥¼ ì¶”ê°€í•˜ì„¸ìš”.');
    console.log('ê°œë°œì ë„êµ¬ì—ì„œ í•„ìš” ì‹œ: addSampleData() ë˜ëŠ” fixMissingFields()');
    
    // ğŸš¨ ê¸´ê¸‰ ê°€ì´ë“œ ì¶œë ¥
    console.log('');
    console.log('ğŸš¨ Firestore ì¸ë±ìŠ¤ ë¬¸ì œ í•´ê²° ê°€ì´ë“œ');
    console.log('=====================================');
    console.log('');
    console.log('1ï¸âƒ£ ì¦‰ì‹œ ì‹¤í–‰í•˜ì„¸ìš”:');
    console.log('  fixMissingFields()     // ê¸°ì¡´ ë¬¸ì„œ í•„ë“œ ë³´ì •');
    console.log('  addSampleData()        // ìƒ˜í”Œ ë°ì´í„° ì¶”ê°€');
    console.log('');
    console.log('2ï¸âƒ£ ì¸ë±ìŠ¤ ìƒì„± ê°€ì´ë“œ:');
    console.log('  createIndexes()        // ìƒì„¸ ê°€ì´ë“œ ë³´ê¸°');
    console.log('');
    console.log('3ï¸âƒ£ ê°œë°œì ë„êµ¬ì—ì„œ ë‹¤ìŒ í•¨ìˆ˜ë“¤ ì‚¬ìš© ê°€ëŠ¥:');
    console.log('  habitSalonUtils.fixMissingFields()');
    console.log('  habitSalonUtils.addSampleData()');
    console.log('  habitSalonUtils.createIndexes()');
    console.log('');
    console.log('ğŸ“Œ ì£¼ì˜: ì¸ë±ìŠ¤ê°€ ì—†ìœ¼ë©´ ë¹ˆ ê²°ê³¼ê°€ ë‚˜ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤!');
    console.log('   í˜„ì¬ëŠ” í´ë¼ì´ì–¸íŠ¸ í•„í„°ë§ìœ¼ë¡œ ì„ì‹œ í•´ê²°ë¨');
    console.log('=====================================');
    console.log('');
    
    // ğŸ”„ ì˜¤í”„ë¼ì¸ ì•¡ì…˜ ë™ê¸°í™” í•¨ìˆ˜
    window.syncOfflineActions = async function() {
      try {
        const offlineActions = JSON.parse(localStorage.getItem('offlineActions') || '[]');
        
        if (offlineActions.length === 0) {
          console.log('ë™ê¸°í™”í•  ì˜¤í”„ë¼ì¸ ì•¡ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }
        
        if (!window.isOnline) {
          console.log('ì˜¤í”„ë¼ì¸ ìƒíƒœ - ë™ê¸°í™”ë¥¼ ë‚˜ì¤‘ì— ì‹œë„í•©ë‹ˆë‹¤.');
          window.showSalonToast('ë„¤íŠ¸ì›Œí¬ ì—°ê²° í›„ ìë™ ë™ê¸°í™”ë©ë‹ˆë‹¤.', 'info');
          return;
        }
        
        console.log(`ğŸ”„ ${offlineActions.length}ê°œì˜ ì˜¤í”„ë¼ì¸ ì•¡ì…˜ ë™ê¸°í™” ì‹œì‘...`);
        let successCount = 0;
        let failCount = 0;
        
        for (const action of offlineActions) {
          try {
            if (action.type === 'addPoints') {
              // ì˜¤í”„ë¼ì¸ì—ì„œ ì¶”ê°€ëœ í¬ì¸íŠ¸ë¥¼ ì„œë²„ì— ë™ê¸°í™”
              await window.addUserPoints(action.pointsToAdd, action.source, action.actionId);
              successCount++;
            }
            // ë‹¤ë¥¸ ì•¡ì…˜ íƒ€ì…ë“¤ë„ ì—¬ê¸°ì— ì¶”ê°€ ê°€ëŠ¥
          } catch (error) {
            console.error('ì•¡ì…˜ ë™ê¸°í™” ì˜¤ë¥˜:', action, error);
            failCount++;
          }
        }
        
        // ì„±ê³µí•œ ì•¡ì…˜ë“¤ì€ íì—ì„œ ì œê±°
        if (successCount > 0) {
          localStorage.removeItem('offlineActions');
          console.log(`âœ… ${successCount}ê°œ ì•¡ì…˜ ë™ê¸°í™” ì™„ë£Œ`);
          window.showSalonToast(`${successCount}ê°œ ì˜¤í”„ë¼ì¸ ì•¡ì…˜ì´ ë™ê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ”„`, 'success');
        }
        
        if (failCount > 0) {
          console.log(`âŒ ${failCount}ê°œ ì•¡ì…˜ ë™ê¸°í™” ì‹¤íŒ¨`);
          window.showSalonToast(`${failCount}ê°œ ì•¡ì…˜ ë™ê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.`, 'warning');
        }
        
      } catch (error) {
        console.error('ì˜¤í”„ë¼ì¸ ì•¡ì…˜ ë™ê¸°í™” ì˜¤ë¥˜:', error);
        window.showSalonToast('ë™ê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
      }
    };
    
    // ë„¤íŠ¸ì›Œí¬ ë³µêµ¬ ì‹œ ìë™ ë™ê¸°í™” (ê¸°ì¡´ online ì´ë²¤íŠ¸ì— ì¶”ê°€)
    const originalOnlineHandler = window.addEventListener('online', () => {
      console.log('ğŸŒ ë„¤íŠ¸ì›Œí¬ ì—°ê²°ë¨ - Firestore ì¬ì—°ê²° ì‹œë„');
      window.isOnline = true;
      window.showSalonToast('ë„¤íŠ¸ì›Œí¬ê°€ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸŒ', 'success');
      enableNetwork(db).catch(error => {
        console.log('Firestore ë„¤íŠ¸ì›Œí¬ ì¬í™œì„±í™” ì˜¤ë¥˜:', error);
      });
      
      // ìë™ ë™ê¸°í™” ì¶”ê°€
      setTimeout(async () => {
        try {
          await window.syncOfflineActions();
          // ìºì‹œ ìƒˆë¡œê³ ì¹¨ë„ ì‹œë„
          const habitSalonMain = document.getElementById('habit-salon-main');
          if (habitSalonMain && habitSalonMain.style.display !== 'none') {
            console.log('ë„¤íŠ¸ì›Œí¬ ë³µêµ¬ - ìŠµê´€ì‚´ë¡± ë°ì´í„° ìƒˆë¡œê³ ì¹¨');
            // í˜„ì¬ í™œì„± ì„¹ì…˜ ìƒˆë¡œê³ ì¹¨
            const activeSections = ['brand', 'question', 'free'];
            for (const section of activeSections) {
              const sectionElement = document.getElementById(`habit-salon-${section}`);
              if (sectionElement && sectionElement.style.display !== 'none') {
                await window.showHabitSalonSection(section);
                break;
              }
            }
          }
        } catch (error) {
          console.error('ë„¤íŠ¸ì›Œí¬ ë³µêµ¬ í›„ ë™ê¸°í™” ì˜¤ë¥˜:', error);
        }
      }, 2000); // 2ì´ˆ í›„ ë™ê¸°í™” ì‹œë„
    });

    // í˜ì´ì§€ ë¡œë“œ í›„ ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', function() {
      // ì´ˆê¸° ë„¤íŠ¸ì›Œí¬ ìƒíƒœ ì„¤ì •
      window.isOnline = navigator.onLine;
      console.log('ì´ˆê¸° ë„¤íŠ¸ì›Œí¬ ìƒíƒœ:', window.isOnline ? 'ì˜¨ë¼ì¸' : 'ì˜¤í”„ë¼ì¸');
      
      // ë„¤íŠ¸ì›Œí¬ ìƒíƒœ ëª¨ë‹ˆí„°ë§
      window.addEventListener('online', async () => {
        console.log('ğŸŒ ë„¤íŠ¸ì›Œí¬ ì—°ê²°ë¨');
        window.isOnline = true;
        window.showSalonToast('ë„¤íŠ¸ì›Œí¬ê°€ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸŒ', 'success');
        
        try {
          await window.syncOfflineActions();
          // í˜„ì¬ ì„¹ì…˜ ìƒˆë¡œê³ ì¹¨
          const habitSalonMain = document.getElementById('habit-salon-main');
          if (habitSalonMain?.style.display !== 'none') {
            const sections = ['brand', 'question', 'free'];
            for (const section of sections) {
              const sectionElement = document.getElementById(`habit-salon-${section}`);
              if (sectionElement?.style.display !== 'none') {
                await window.showHabitSalonSection(section);
                break;
              }
            }
          }
        } catch (error) {
          console.error('ë„¤íŠ¸ì›Œí¬ ë³µêµ¬ í›„ ë™ê¸°í™” ì˜¤ë¥˜:', error);
        }
      });
      
      window.addEventListener('offline', () => {
        console.log('ğŸ“´ ë„¤íŠ¸ì›Œí¬ ì—°ê²° ëŠê¹€');
        window.isOnline = false;
        window.showSalonToast('ì˜¤í”„ë¼ì¸ ìƒíƒœì…ë‹ˆë‹¤. ì¼ë¶€ ê¸°ëŠ¥ì´ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'warning');
      });
      
      // ìŠµê´€ì‚´ë¡± ì§„ì… ë²„íŠ¼ ì´ˆê¸°í™”
      const enterBtn = document.getElementById('habit-salon-enter-btn');
      if (enterBtn) {
        enterBtn.addEventListener('click', async function() {
          try {
            document.getElementById('main-section').style.display = 'none';
            document.getElementById('habit-salon-main').style.display = 'block';
            await window.initHabitSalon();
          } catch (error) {
            console.error('ìŠµê´€ì‚´ë¡± ì§„ì… ì˜¤ë¥˜:', error);
            window.showSalonToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'error');
          }
        });
      }
    });

    // ìƒ˜í”Œ ë°ì´í„° ì¶”ê°€ í•¨ìˆ˜ (ë¹„í™œì„±í™”ë¨)
    window.addSampleData = async function() {
      console.log('');
      console.log('âš ï¸ ìƒ˜í”Œ ë°ì´í„° ì¶”ê°€ê°€ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
      console.log('ë°ì´í„° ê´€ë¦¬ëŠ” Firebase Consoleì—ì„œ ì§„í–‰í•´ì£¼ì„¸ìš”:');
      console.log('https://console.firebase.google.com/project/neulbom-healt-quiz/firestore');
      return;
    };

    // í•„ë“œ ë³´ì • í•¨ìˆ˜ (ë¹„í™œì„±í™”ë¨)
    window.fixMissingFields = async function() {
      console.log('');
      console.log('âš ï¸ í•„ë“œ ë³´ì • ê¸°ëŠ¥ì´ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
      console.log('ë°ì´í„° ê´€ë¦¬ëŠ” Firebase Consoleì—ì„œ ì§„í–‰í•´ì£¼ì„¸ìš”:');
      console.log('https://console.firebase.google.com/project/neulbom-healt-quiz/firestore');
      return;
    };

    // ì½˜ì†”ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤ (ë°ì´í„° ê´€ë¦¬ ê¸°ëŠ¥ ì œì™¸)
    window.habitSalonUtils = {
      getUserPoints: window.getUserPoints,
      loadBrandPosts: window.loadBrandPosts,
      loadHealthQuestions: window.loadHealthQuestions,
      loadUserPosts: window.loadUserPosts,
      syncOfflineActions: window.syncOfflineActions
    };
    
    console.log('ğŸš¨ Firestore ì—°ê²° ë¬¸ì œ ì™„ì „ í•´ê²°!');
    console.log('=====================================');
    console.log('');
    console.log('âœ… ì ìš©ëœ í•´ê²°ì±…:');
    console.log('  - ì˜¤í”„ë¼ì¸ ì§€ì› í™œì„±í™” âœ“');
    console.log('  - ë„¤íŠ¸ì›Œí¬ ìƒíƒœ ìë™ ê°ì§€ âœ“');
    console.log('  - ìºì‹œ ì‹œìŠ¤í…œ êµ¬í˜„ âœ“');
    console.log('  - ê°•í™”ëœ ì˜¤ë¥˜ ì²˜ë¦¬ âœ“');
    console.log('  - ìë™ ë™ê¸°í™” ì‹œìŠ¤í…œ âœ“');
    console.log('');
    console.log('ğŸ”§ ì¦‰ì‹œ ì‹¤í–‰ í•¨ìˆ˜:');
    console.log('  fixMissingFields()     // ê¸°ì¡´ ë¬¸ì„œ í•„ë“œ ë³´ì •');
    console.log('  addSampleData()        // ìƒ˜í”Œ ë°ì´í„° ì¶”ê°€');
    console.log('  syncOfflineActions()   // ì˜¤í”„ë¼ì¸ ì•¡ì…˜ ë™ê¸°í™”');
    console.log('');
    console.log('ğŸ“Š ì¸ë±ìŠ¤ ìƒì„± ê°€ì´ë“œ:');
    console.log('  createIndexes()        // ìƒì„¸ ê°€ì´ë“œ ë³´ê¸°');
    console.log('');
    console.log('ğŸ”„ ê°œë°œì ë„êµ¬ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë“  í•¨ìˆ˜:');
    console.log('  habitSalonUtils.fixMissingFields()');
    console.log('  habitSalonUtils.addSampleData()');
    console.log('  habitSalonUtils.syncOfflineActions()');
    console.log('  habitSalonUtils.createIndexes()');
    console.log('');
    console.log('ğŸ’¡ í˜„ì¬ ìƒíƒœ:');
    console.log('  ë„¤íŠ¸ì›Œí¬:', window.isOnline ? 'ğŸŸ¢ ì˜¨ë¼ì¸' : 'ğŸ”´ ì˜¤í”„ë¼ì¸');
    console.log('  Firestore: ì˜¤í”„ë¼ì¸ ì§€ì› í™œì„±í™”ë¨ âœ“');
    console.log('=====================================');
    console.log('');
    
    // ì „ì²´ í™”ë©´ ë¸Œëœë“œ ì´ì•¼ê¸° í˜ì´ì§€ í•¨ìˆ˜ë“¤
    window.openBrandStoryPage = async function() {
      try {
        history.pushState({ page: 'brand-story' }, '');
        // ë¡œë”© í‘œì‹œ
        const overlay = document.getElementById('page-transition-overlay');
        overlay.classList.add('active');
        
        // ë¸Œëœë“œ ë°ì´í„° ë¡œë”©
        const posts = await window.loadBrandPosts();
        
        if (posts.length === 0) {
          window.showSalonToast('ë¸Œëœë“œ ì´ì•¼ê¸°ê°€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.', 'info');
          overlay.classList.remove('active');
          return;
        }
        
        // ì¹´ë“œ ìŠ¬ë¼ì´ë” ì´ˆê¸°í™”
        currentCards = posts;
        currentSection = 'brand';
        currentCardIndex = 0;
        
        // ë¸Œëœë“œ ìŠ¤í† ë¦¬ ì½˜í…ì¸  ìƒì„±
        const container = document.getElementById('brand-story-content');
        container.innerHTML = `
          <div class="card-slider-container">
            <div class="card-slider" id="brand-fullscreen-slider">
              ${posts.map((post, index) => `
                <div class="story-card" data-index="${index}">
                  ${post.imageUrl ? `<img src="${post.imageUrl}" alt="ë¸Œëœë“œ ì´ë¯¸ì§€" class="story-card-image">` : 
                    '<div class="story-card-image" style="display:flex;align-items:center;justify-content:center;font-size:64px;background:linear-gradient(135deg,#356c55,#4a7c59);">ğŸŒ¿</div>'}
                  <div class="story-card-content">
                    <h3 class="story-card-title">${post.title || 'ëŠ˜ë´„ ë¸Œëœë“œ ì´ì•¼ê¸°'}</h3>
                    <p class="story-card-text">${post.content}</p>
                    <div class="story-card-meta">
                      <div class="story-card-author">
                        <div class="story-card-avatar">ëŠ˜</div>
                        <div class="story-card-author-info">
                          <div class="story-card-author-name">${post.author || 'ëŠ˜ë´„íŒ€'}</div>
                          <div class="story-card-time">${window.formatTime(post.timestamp)}</div>
                        </div>
                      </div>
                      <div class="story-card-actions">
                        <button class="story-action-btn" onclick="window.toggleStoryLike('brand', '${post.id}', ${index})">
                          <span id="like-icon-brand-${index}">â¤ï¸</span>
                          <span id="like-count-brand-${index}">${post.likes || 0}</span>
                        </button>
                        <button class="story-action-btn comment-btn" onclick="window.toggleStoryComments('brand', '${post.id}', ${index})">
                          <span>ğŸ’¬</span>
                          <span id="comment-count-brand-${index}">${post.commentCount || 0}</span>
                        </button>
                      </div>
                    </div>
                  </div>
                  <div class="story-comments-section active" id="comments-brand-${index}">
                    <div class="story-comments-header">
                      ëŒ“ê¸€ <span id="comment-header-count-brand-${index}">${post.commentCount || 0}</span>ê°œ
                    </div>
                    <div class="story-comments-list" id="comment-list-brand-${index}">
                      <!-- ëŒ“ê¸€ ëª©ë¡ì´ ì—¬ê¸°ì— ë¡œë“œë©ë‹ˆë‹¤ -->
                    </div>
                    <div class="story-comment-input">
                      <div class="story-comment-form">
                        <textarea id="comment-input-brand-${index}" class="story-comment-textarea" 
                                  placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”... (+30P)" maxlength="200"></textarea>
                        <button onclick="window.submitStoryComment('brand', '${post.id}', ${index})" 
                                class="story-comment-submit">ë“±ë¡</button>
                      </div>
                    </div>
                  </div>
                </div>
              `).join('')}
            </div>
            ${posts.length > 1 ? `
              <button class="card-nav prev" onclick="window.prevCard()" id="prev-btn">â€¹</button>
              <button class="card-nav next" onclick="window.nextCard()" id="next-btn">â€º</button>
            ` : ''}
          </div>
          ${posts.length > 1 ? `
            <div class="card-indicators">
              ${posts.map((_, index) => `
                <div class="card-indicator ${index === 0 ? 'active' : ''}" 
                     onclick="window.goToCard(${index})" data-index="${index}"></div>
              `).join('')}
            </div>
          ` : ''}
        `;
        
        // í˜ì´ì§€ ì „í™˜ ì• ë‹ˆë©”ì´ì…˜
        setTimeout(() => {
          overlay.classList.remove('active');
          const fullscreenPage = document.getElementById('brand-story-fullscreen');
          fullscreenPage.classList.add('active');
          
          // ì¹´ë“œ ë„¤ë¹„ê²Œì´ì…˜ ì—…ë°ì´íŠ¸
          window.updateCardNavigation();
          
          // ë°”ë”” ìŠ¤í¬ë¡¤ ë°©ì§€
          document.body.style.overflow = 'hidden';
        }, 200);
        
      } catch (error) {
        console.error('ë¸Œëœë“œ ìŠ¤í† ë¦¬ í˜ì´ì§€ ì—´ê¸° ì˜¤ë¥˜:', error);
        window.showSalonToast('í˜ì´ì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
        const overlay = document.getElementById('page-transition-overlay');
        overlay.classList.remove('active');
      }
    };
    
    window.closeBrandStoryPage = function() {
      const fullscreenPage = document.getElementById('brand-story-fullscreen');
      if (fullscreenPage) {
        fullscreenPage.classList.remove('active');
        document.body.style.overflow = '';
      }
    };
    
    // ESC í‚¤ë¡œ ì „ì²´ í™”ë©´ í˜ì´ì§€ ë‹«ê¸°
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        const fullscreenPage = document.getElementById('brand-story-fullscreen');
        if (fullscreenPage.classList.contains('active')) {
          window.closeBrandStoryPage();
        }
      }
    });
    
    // ì¹´ë“œ ìŠ¬ë¼ì´ë” ë„¤ë¹„ê²Œì´ì…˜ í•¨ìˆ˜ë“¤

    // ì „ì²´ í™”ë©´ ì˜¤ëŠ˜ì˜ ì§ˆë¬¸ í˜ì´ì§€
    window.openQuestionPage = async function() {
      try {
        history.pushState({ page: 'question' }, '');
        const overlay = document.getElementById('page-transition-overlay');
        overlay.classList.add('active');

        // ì§ˆë¬¸ ë°ì´í„° ë¡œë”©
        const questions = await window.loadHealthQuestions();
        // ì¹´ë“œ ìŠ¬ë¼ì´ë” í˜•íƒœë¡œ ë Œë”ë§
        const container = document.querySelector('#question-fullscreen .fullscreen-page-content');
        if (!container) return;

        if (questions.length === 0) {
          container.innerHTML = '<div style="text-align:center;padding:40px;color:#666;">ì˜¤ëŠ˜ì˜ ì§ˆë¬¸ì´ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.</div>';
        } else {
          window.currentCards = questions;
          window.currentSection = 'question';
          window.currentCardIndex = 0;
          container.innerHTML = `
            <div class="card-slider-container">
              <div class="card-slider" id="question-card-slider">
                ${questions.map((question, index) => `
                  <div class="story-card question-card" data-index="${index}">
                    <div class="story-card-content">
                      <h3 class="story-card-title">ğŸ“ ${question.question}</h3>
                      <div class="question-options">
                        ${question.options ? question.options.map((option, optionIndex) => `
                          <button class="question-option" 
                                  onclick="window.answerStoryQuestion('${question.id}', ${optionIndex}, ${index})"
                                  id="option-${index}-${optionIndex}">
                            ${option}
                          </button>
                        `).join('') : ''}
                      </div>
                      <div class="question-reward">ğŸ’¡ ë‹µë³€í•˜ë©´ 30Pê°€ ì ë¦½ë©ë‹ˆë‹¤!</div>
                    </div>
                    <div class="story-comments-section active" id="comments-question-${index}">
                      <div class="story-comments-header">
                        ëŒ“ê¸€ <span id="comment-header-count-question-${index}">${question.commentCount || 0}</span>ê°œ
                      </div>
                      <div class="story-comments-list" id="comment-list-question-${index}"></div>
                      <div class="story-comment-input">
                        <div class="story-comment-form">
                          <textarea id="comment-input-question-${index}" class="story-comment-textarea" 
                                    placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”... (+30P)" maxlength="200"></textarea>
                          <button onclick="window.submitStoryComment('question', '${question.id}', ${index})" 
                                  class="story-comment-submit">ë“±ë¡</button>
                        </div>
                      </div>
                    </div>
                  </div>
                `).join('')}
              </div>
              ${questions.length > 1 ? `
                <button class="card-nav prev" onclick="window.prevCard()" id="prev-btn">â€¹</button>
                <button class="card-nav next" onclick="window.nextCard()" id="next-btn">â€º</button>
              ` : ''}
            </div>
            ${questions.length > 1 ? `
              <div class="card-indicators">
                ${questions.map((_, index) => `
                  <div class="card-indicator ${index === 0 ? 'active' : ''}" 
                       onclick="window.goToCard(${index})" data-index="${index}"></div>
                `).join('')}
              </div>
            ` : ''}
            <div style="text-align:center;margin-top:20px;padding:16px;background:#f8f9fa;border-radius:12px;">
              <p style="margin:0;color:#356c55;font-weight:600;">ğŸ’š í˜„ì¬ í¬ì¸íŠ¸: <span id="habit-salon-my-point">${await window.getUserPoints()}</span>P</p>
            </div>
          `;
          setTimeout(() => { window.updateCardNavigation(); }, 0);
        }

        // ê¸°ì¡´ ì‘ì€ ë¦¬ìŠ¤íŠ¸ UI ìˆ¨ê¹€
        const mainSection = document.getElementById('habit-salon-main');
        if (mainSection) mainSection.style.display = 'none';

        setTimeout(() => {
          overlay.classList.remove('active');
          const fullscreenPage = document.getElementById('question-fullscreen');
          fullscreenPage.classList.add('active');
          document.body.style.overflow = 'hidden';
        }, 200);
      } catch (error) {
        console.error('ì§ˆë¬¸ í˜ì´ì§€ ì—´ê¸° ì˜¤ë¥˜:', error);
        window.showSalonToast('í˜ì´ì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
        const overlay = document.getElementById('page-transition-overlay');
        overlay.classList.remove('active');
      }
    };

    window.closeQuestionPage = function() {
      const fullscreenPage = document.getElementById('question-fullscreen');
      if (fullscreenPage) {
        fullscreenPage.classList.remove('active');
        document.body.style.overflow = '';
        // ë„¤ë¹„ê²Œì´ì…˜ ì„¹ì…˜ ë³µê·€
        const mainSection = document.getElementById('habit-salon-main');
        if (mainSection) mainSection.style.display = 'block';
      }
    };

    // ESC í‚¤ë¡œ ì „ì²´ í™”ë©´ í˜ì´ì§€ ë‹«ê¸° (ë¸Œëœë“œ/ììœ ê¸€ê³¼ ë™ì¼í•˜ê²Œ questionë„ ì ìš©)
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        const fullscreenPage = document.getElementById('question-fullscreen');
        if (fullscreenPage && fullscreenPage.classList.contains('active')) {
          window.closeQuestionPage();
        }
      }
    });

    // ì „ì²´ í™”ë©´ ììœ ê¸€(ê±´ê°• í•œë§ˆë‹¹) í˜ì´ì§€
    window.openFreePage = async function() {
      // ëª¨ë“  ì„¹ì…˜ ìˆ¨ê¹€
      document.getElementById('main-section').style.display = 'none';
      document.getElementById('habit-salon-main').style.display = 'none';
      document.getElementById('habit-salon-brand').style.display = 'none';
      document.getElementById('habit-salon-question').style.display = 'none';
      document.getElementById('habit-salon-challenge').style.display = 'none';
      
      // habit-salon-free ì„¹ì…˜ë„ ì¼ë‹¨ ìˆ¨ê¹€ (ì „ì²´í™”ë©´ìœ¼ë¡œ í‘œì‹œí•˜ê¸° ì „ì—)
      const originalFree = document.getElementById('habit-salon-free');
      if (originalFree && originalFree.parentElement === document.getElementById('habit-salon-main')) {
        originalFree.style.display = 'none';
      }

      // í”Œë¡œíŒ… ë²„íŠ¼ì„ ì„ì‹œ ì €ì¥
      const floatingBtn = document.getElementById('floating-write-btn');
      if (floatingBtn) {
        floatingBtn.remove(); // ê¸°ì¡´ ìœ„ì¹˜ì—ì„œ ì œê±°
      }

      // habit-salon-freeë¥¼ bodyë¡œ ì´ë™ (ì¤‘ë³µ ë°©ì§€ë¥¼ ìœ„í•´ ê¸°ì¡´ ìœ„ì¹˜ì—ì„œ ì œê±°)
      const free = document.getElementById('habit-salon-free');
      if (free && free.parentElement !== document.body) {
        document.body.appendChild(free);
        // í”Œë¡œíŒ… ë²„íŠ¼ì„ habit-salon-freeì˜ ë§ˆì§€ë§‰ ìì‹ìœ¼ë¡œ ë‹¤ì‹œ ì¶”ê°€
        if (floatingBtn) {
          free.appendChild(floatingBtn);
        }
      }

      // ììœ ê²Œì‹œíŒ ì „ì²´í™”ë©´ ìŠ¤íƒ€ì¼ ì ìš©
      free.style.display = 'block';
      free.style.position = 'fixed';
      free.style.width = '100vw';
      free.style.height = '100vh';
      free.style.top = '0';
      free.style.left = '0';
      free.style.background = '#fcfaf5';
      free.style.zIndex = '99990';
      free.style.overflowY = 'auto';
      free.style.margin = '0';
      free.style.padding = '0';

      // ë¶ˆí•„ìš”í•œ ìš”ì†Œ ìˆ¨ê¹€
      const elementsToHide = free.querySelectorAll('.logo, h2:not(#free-title), p:not(.point-text)');
      elementsToHide.forEach(el => el.style.display = 'none');

      // ë’¤ë¡œê°€ê¸° ë²„íŠ¼ ì¶”ê°€ (ì—†ëŠ” ê²½ìš°ì—ë§Œ)
      if (!document.getElementById('free-back-btn')) {
        const backBtn = document.createElement('button');
        backBtn.className = 'fullscreen-back-btn';
        backBtn.id = 'free-back-btn';
        backBtn.innerText = 'â† ë’¤ë¡œê°€ê¸°';
        backBtn.onclick = window.closeFreePage;
        free.insertBefore(backBtn, free.firstChild);
      }

      // íƒ€ì´í‹€ ì¶”ê°€ (ì—†ëŠ” ê²½ìš°ì—ë§Œ)
      if (!document.getElementById('free-title')) {
        const title = document.createElement('h1');
        title.className = 'fullscreen-page-title';
        title.id = 'free-title';
        title.innerText = 'ğŸ’¬ ê±´ê°• í•œë§ˆë‹¹';
        free.insertBefore(title, free.children[1]);
      }

      // í”¼ë“œ ë¡œë“œ
      await window.loadFreeSection();

      // habit-salon-free-listë¡œ ìŠ¤í¬ë¡¤
      const freeList = document.getElementById('habit-salon-free-list');
      if (freeList) freeList.scrollIntoView();
    };

    window.closeFreePage = function() {
      // habit-salon-free ìŠ¤íƒ€ì¼ ì´ˆê¸°í™”
      const free = document.getElementById('habit-salon-free');
      if (!free) return;

      // ëª¨ë“  ìŠ¤íƒ€ì¼ ì´ˆê¸°í™”
      free.style.display = '';
      free.style.position = '';
      free.style.width = '';
      free.style.height = '';
      free.style.top = '';
      free.style.left = '';
      free.style.background = '';
      free.style.zIndex = '';
      free.style.overflowY = '';
      free.style.margin = '';
      free.style.padding = '';
      free.classList.remove('fullscreen');

      // ìˆ¨ê²¨ì§„ ìš”ì†Œë“¤ ë³µì›
      const hiddenElements = free.querySelectorAll('.logo, h2, p');
      hiddenElements.forEach(el => el.style.display = '');

      // ë’¤ë¡œê°€ê¸°/íƒ€ì´í‹€ ì œê±°
      const backBtn = document.getElementById('free-back-btn');
      if (backBtn) backBtn.remove();
      const title = document.getElementById('free-title');
      if (title) title.remove();

      // ë„¤ë¹„ê²Œì´ì…˜ ì„¹ì…˜ ë³µì›
      document.getElementById('habit-salon-main').style.display = 'block';
      document.getElementById('main-section').style.display = 'block';

      // í”Œë¡œíŒ… ë²„íŠ¼ì„ ì„ì‹œ ì €ì¥
      const floatingBtn = document.getElementById('floating-write-btn');
      if (floatingBtn) {
        floatingBtn.remove(); // í˜„ì¬ ìœ„ì¹˜ì—ì„œ ì œê±°
      }

      // habit-salon-freeë¥¼ ì›ë˜ ìœ„ì¹˜ë¡œ ì´ë™
      const habitSalonMain = document.getElementById('habit-salon-main');
      if (habitSalonMain) {
        const freeSection = habitSalonMain.querySelector('#habit-salon-free');
        if (!freeSection) {
          habitSalonMain.appendChild(free);
          // í”Œë¡œíŒ… ë²„íŠ¼ì„ habit-salon-freeì˜ ë§ˆì§€ë§‰ ìì‹ìœ¼ë¡œ ë‹¤ì‹œ ì¶”ê°€
          if (floatingBtn) {
            free.appendChild(floatingBtn);
          }
        }
      }
    };

    // ESC í‚¤ë¡œ ì „ì²´ í™”ë©´ í˜ì´ì§€ ë‹«ê¸°
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        const free = document.getElementById('habit-salon-free');
        if (free && free.style.position === 'fixed') {
          window.closeFreePage();
        }
      }
    });

    window.openWriteModal = function() {
      try {
        history.pushState({ page: 'write' }, '');
        const modal = document.getElementById('free-write-fullscreen');
        if (modal) {
          modal.classList.add('active');
          document.body.style.overflow = 'hidden';
        }
      } catch (error) {
        console.error('ê¸€ì“°ê¸° ëª¨ë‹¬ ì—´ê¸° ì˜¤ë¥˜:', error);
      }
    };

    window.closeWriteModal = function() {
      const modal = document.getElementById('free-write-fullscreen');
      if (modal) {
        modal.classList.remove('active');
        document.body.style.overflow = '';
      }
    };

    // ëª¨ë°”ì¼ ë’¤ë¡œê°€ê¸° ë²„íŠ¼ ì²˜ë¦¬
    window.addEventListener('popstate', function(e) {
      // ë©”ì¸ ì„¹ì…˜ í‘œì‹œ
      const mainSection = document.getElementById('habit-salon-main');
      if (mainSection) {
        mainSection.style.display = 'block';
      }
      
      // ê° ì„¹ì…˜ ë‹«ê¸°
      const brandStoryPage = document.getElementById('brand-story-fullscreen');
      const questionPage = document.getElementById('question-fullscreen');
      const freePage = document.getElementById('habit-salon-free');
      const writeModal = document.getElementById('free-write-fullscreen');
      
      if (brandStoryPage?.classList.contains('active')) {
        window.closeBrandStoryPage();
      }
      
      if (questionPage?.classList.contains('active')) {
        window.closeQuestionPage();
      }
      
      if (freePage?.style.position === 'fixed') {
        window.closeFreePage();
      }
      
      if (writeModal?.classList.contains('active')) {
        window.closeWriteModal();
      }
      
      // ìŠ¤í¬ë¡¤ ë³µì›
      document.body.style.overflow = '';
    });
    // ... existing code ...

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì´ˆê¸°í™” í•¨ìˆ˜
    window.initializeEventListeners = function() {
      console.log('ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì´ˆê¸°í™” ì‹œì‘');
      
      // ë„¤ë¹„ê²Œì´ì…˜ ì¹´ë“œ
      const navCards = document.querySelectorAll('.habit-salon-nav-card');
      console.log('ì°¾ì€ ë„¤ë¹„ê²Œì´ì…˜ ì¹´ë“œ ìˆ˜:', navCards.length);
      
      navCards.forEach(card => {
        const section = card.dataset.section;
        console.log('ë„¤ë¹„ê²Œì´ì…˜ ì¹´ë“œ ì„¤ì •:', section);
        
        // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
        card.removeEventListener('click', card.clickHandler);
        
        // ìƒˆë¡œìš´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        card.clickHandler = function() {
          console.log('ë„¤ë¹„ê²Œì´ì…˜ ì¹´ë“œ í´ë¦­ë¨:', section);
          if (section === 'brand') {
            window.openBrandStoryPage();
          } else if (section === 'question') {
            window.openQuestionPage();
          } else if (section === 'free') {
            window.openFreePage(); // ê¸°ì¡´ showHabitSalonSection('free')ì—ì„œ ë³€ê²½
          } else if (section === 'challenge') {
            window.showHabitSalonSection('challenge');
          }
        };
        
        card.addEventListener('click', card.clickHandler);
        
        // í˜¸ë²„ íš¨ê³¼
        card.addEventListener('mouseenter', function() {
          this.style.boxShadow = '0 4px 16px rgba(53,108,85,0.15)';
        });
        
        card.addEventListener('mouseleave', function() {
          this.style.boxShadow = '0 2px 8px #e0ede3';
        });
      });
      
      // ë’¤ë¡œê°€ê¸° ë²„íŠ¼
      const backBtn = document.getElementById('habit-salon-main-back-btn');
      if (backBtn) {
        backBtn.addEventListener('click', function() {
          document.getElementById('habit-salon-main').style.display = 'none';
          document.getElementById('main-section').style.display = 'block';
        });
      }
      
      console.log('ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì´ˆê¸°í™” ì™„ë£Œ');
    };

    // DOMì´ ë¡œë“œëœ í›„ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', function() {
      // ì´ˆê¸° ë„¤íŠ¸ì›Œí¬ ìƒíƒœ ì„¤ì •
      window.isOnline = navigator.onLine;
      console.log('ì´ˆê¸° ë„¤íŠ¸ì›Œí¬ ìƒíƒœ:', window.isOnline ? 'ì˜¨ë¼ì¸' : 'ì˜¤í”„ë¼ì¸');
      
      // ìŠµê´€ì‚´ë¡± ì§„ì… ë²„íŠ¼ ì´ˆê¸°í™”
      const enterBtn = document.getElementById('habit-salon-enter-btn');
      if (enterBtn) {
        enterBtn.addEventListener('click', async function() {
          try {
            document.getElementById('main-section').style.display = 'none';
            document.getElementById('habit-salon-main').style.display = 'block';
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì´ˆê¸°í™”ë¥¼ ì—¬ê¸°ì„œë„ ì‹¤í–‰
            window.initializeEventListeners();
            await window.initHabitSalon();
          } catch (error) {
            console.error('ìŠµê´€ì‚´ë¡± ì§„ì… ì˜¤ë¥˜:', error);
            window.showSalonToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'error');
          }
        });
      }
      
      // ì´ˆê¸° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
      window.initializeEventListeners();
    });

    // ììœ  ê²Œì‹œíŒ ê²Œì‹œê¸€ ë¡œë”©
    window.loadUserPosts = async function() {
      try {
        console.log('Firebaseì—ì„œ ììœ  ê²Œì‹œê¸€ ë¡œë”© ì¤‘...');
        
        // ì˜¤í”„ë¼ì¸ ìƒíƒœ ì‹œ ìºì‹œëœ ë°ì´í„° ì‚¬ìš©
        if (!window.isOnline) {
          console.log('ì˜¤í”„ë¼ì¸ ìƒíƒœ - ìºì‹œëœ ììœ  ê²Œì‹œê¸€ ì‚¬ìš©');
          const cachedData = localStorage.getItem('cached_user_posts');
          if (cachedData) {
            const posts = JSON.parse(cachedData);
            console.log('ìºì‹œëœ ììœ  ê²Œì‹œê¸€:', posts.length, 'ê°œ');
            return posts;
          }
          return [];
        }
        
        // Firestoreì—ì„œ ì§ì ‘ í•„í„°ë§
        const q = query(
          collection(db, 'user_posts'),
          orderBy('timestamp', 'desc')
        );
        
        const snapshot = await getDocs(q);
        const posts = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data(),
          isLiked: false // ì¢‹ì•„ìš” ìƒíƒœëŠ” ë³„ë„ë¡œ ì²´í¬
        }));
        
        // ì„±ê³µì ìœ¼ë¡œ ë¡œë”©ë˜ë©´ ìºì‹œì— ì €ì¥
        if (posts.length > 0) {
          localStorage.setItem('cached_user_posts', JSON.stringify(posts));
          localStorage.setItem('cached_user_posts_time', Date.now().toString());
        }
        
        console.log('ììœ  ê²Œì‹œê¸€ ë¡œë”© ì™„ë£Œ:', posts.length, 'ê°œ');
        return posts;
      } catch (error) {
        console.error('ììœ  ê²Œì‹œê¸€ ë¡œë”© ì˜¤ë¥˜:', error);
        // ì˜¤ë¥˜ ì‹œ ìºì‹œëœ ë°ì´í„° ì‚¬ìš© ì‹œë„
        const cachedData = localStorage.getItem('cached_user_posts');
        if (cachedData) {
          const posts = JSON.parse(cachedData);
          console.log('ì˜¤ë¥˜ ë°œìƒ - ìºì‹œëœ ììœ  ê²Œì‹œê¸€ ì‚¬ìš©:', posts.length, 'ê°œ');
          return posts;
        }
        return [];
      }
    };

    // ììœ ê¸€ ì‘ì„± í•¨ìˆ˜
    window.addUserPost = async function(content) {
      try {
        const userId = window.getUserId();
        const nickname = localStorage.getItem('nickname');
        
        const postData = {
          userId: userId,
          nickname: nickname,
          content: content,
          timestamp: serverTimestamp(),
          likes: 0,
          commentCount: 0
        };
        
        // Firestoreì— ì €ì¥
        const docRef = await addDoc(collection(db, 'user_posts'), postData);
        
        // í¬ì¸íŠ¸ ì§€ê¸‰
        const actionId = `post_${docRef.id}`;
        await window.addUserPoints(100, 'post', actionId);
        
        return docRef.id;
      } catch (error) {
        console.error('ììœ ê¸€ ì‘ì„± ì˜¤ë¥˜:', error);
        throw error;
      }
    };

    // ëŒ“ê¸€ ì‘ì„± í•¨ìˆ˜
    window.addComment = async function(postType, postId, content) {
      try {
        const userId = window.getUserId();
        const nickname = localStorage.getItem('nickname');
        
        const commentData = {
          userId: userId,
          nickname: nickname,
          text: content,  // content ëŒ€ì‹  text í•„ë“œ ì‚¬ìš©
          timestamp: serverTimestamp()
        };
        
        // Firestoreì— ì €ì¥
        const docRef = await addDoc(collection(db, `${postType}_comments`), {
          postId: postId,
          ...commentData
        });
        
        // ëŒ“ê¸€ ìˆ˜ ì—…ë°ì´íŠ¸
        const postRef = doc(db, postType === 'brand' ? 'brand_posts' : 
                           postType === 'question' ? 'health_questions' : 'user_posts', 
                           postId);
        await updateDoc(postRef, {
          commentCount: increment(1)
        });
        
        // í¬ì¸íŠ¸ ì§€ê¸‰
        const actionId = `comment_${postType}_${postId}_${userId}`;
        await window.addUserPoints(30, 'comment', actionId);
        
        return docRef.id;
      } catch (error) {
        console.error('ëŒ“ê¸€ ì‘ì„± ì˜¤ë¥˜:', error);
        throw error;
      }
    };

    // ëŒ“ê¸€ ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜
    window.getComments = async function(postType, postId) {
      try {
        console.log('[ë””ë²„ê¹…] getComments í˜¸ì¶œ:', { postType, postId });
        
        // ì˜¤í”„ë¼ì¸ ìƒíƒœ ì‹œ ìºì‹œëœ ë°ì´í„° ì‚¬ìš©
        if (!window.isOnline) {
          console.log('ì˜¤í”„ë¼ì¸ ìƒíƒœ - ìºì‹œëœ ëŒ“ê¸€ ì‚¬ìš©');
          const cacheKey = `cached_comments_${postType}_${postId}`;
          const cachedData = localStorage.getItem(cacheKey);
          if (cachedData) {
            return JSON.parse(cachedData);
          }
          return [];
        }
        
        // Firestoreì—ì„œ ëŒ“ê¸€ ë¡œë“œ
        const q = query(
          collection(db, `${postType}_comments`),
          where('postId', '==', postId)
        );
        
        console.log('[ë””ë²„ê¹…] Firestore ì¿¼ë¦¬:', { 
          collection: `${postType}_comments`,
          postId: postId
        });
        
        const snapshot = await getDocs(q);
        const comments = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }))
        // í´ë¼ì´ì–¸íŠ¸ì—ì„œ timestampë¡œ ì •ë ¬
        .sort((a, b) => {
          const timeA = a.timestamp?.seconds || 0;
          const timeB = b.timestamp?.seconds || 0;
          return timeB - timeA;  // ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
        });
        
        console.log('[ë””ë²„ê¹…] ë¡œë“œëœ ëŒ“ê¸€:', comments);
        
        // ì„±ê³µì ìœ¼ë¡œ ë¡œë”©ë˜ë©´ ìºì‹œì— ì €ì¥
        if (comments.length > 0) {
          const cacheKey = `cached_comments_${postType}_${postId}`;
          localStorage.setItem(cacheKey, JSON.stringify(comments));
          localStorage.setItem(`${cacheKey}_time`, Date.now().toString());
        }
        
        return comments;
      } catch (error) {
        console.error('ëŒ“ê¸€ ë¡œë“œ ì˜¤ë¥˜:', error);
        
        // ì˜¤ë¥˜ ì‹œ ìºì‹œëœ ë°ì´í„° ì‚¬ìš© ì‹œë„
        const cacheKey = `cached_comments_${postType}_${postId}`;
        const cachedData = localStorage.getItem(cacheKey);
        if (cachedData) {
          return JSON.parse(cachedData);
        }
        return [];
      }
    };

    // í¬ì¸íŠ¸ ì „í™˜ ì‹ ì²­ í•¨ìˆ˜
    window.requestExchange = async function() {
      try {
        const userId = window.getUserId();
        const nickname = localStorage.getItem('nickname');
        const points = await window.getUserPoints();
        
        // 5000í¬ì¸íŠ¸ ë¯¸ë§Œì´ë©´ ì „í™˜ ë¶ˆê°€
        if (points < 5000) {
          window.showSalonToast('5,000í¬ì¸íŠ¸ ì´ìƒë¶€í„° ì „í™˜ ì‹ ì²­ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.', 'warning');
          return;
        }
        
        // ì „í™˜ ì‹ ì²­ ê¸°ë¡ ì €ì¥
        await addDoc(collection(db, "exchangeRequests"), {
          userId: userId,
          nickname: nickname || 'ìµëª…',
          points: points,
          requestedAt: serverTimestamp(),
          status: "pending"
        });
        
        // ì‚¬ìš©ì í¬ì¸íŠ¸ ì°¨ê°
        await updateDoc(doc(db, 'users', userId), {
          points: 0,
          lastExchangeAt: serverTimestamp()
        });
        
        // localStorage í¬ì¸íŠ¸ë„ ì´ˆê¸°í™”
        localStorage.setItem('points', '0');
        
        // UI ì—…ë°ì´íŠ¸
        const pointDisplay = document.getElementById('habit-salon-my-point');
        if (pointDisplay) {
          pointDisplay.textContent = '0';
        }
        
        // ì „í™˜ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
        const exchangeButton = document.getElementById('exchange-button');
        if (exchangeButton) {
          exchangeButton.style.display = 'none';
        }
        
        window.showSalonToast('ì „í™˜ ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ëŠ˜ë´„ëª° ì ë¦½ê¸ˆìœ¼ë¡œ ê³§ ì „í™˜ë©ë‹ˆë‹¤ ğŸ‰', 'success');
        
      } catch (error) {
        console.error('í¬ì¸íŠ¸ ì „í™˜ ì‹ ì²­ ì˜¤ë¥˜:', error);
        window.showSalonToast('ì „í™˜ ì‹ ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
      }
    };

    // í¬ì¸íŠ¸ì— ë”°ë¥¸ ì „í™˜ ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€ ì²˜ë¦¬
    window.updateExchangeButton = async function() {
      try {
        const points = await window.getUserPoints();
        const exchangeButton = document.getElementById('exchange-button');
        
        if (exchangeButton) {
          if (points >= 5000) {
            exchangeButton.style.display = 'block';
          } else {
            exchangeButton.style.display = 'none';
          }
        }
      } catch (error) {
        console.error('ì „í™˜ ë²„íŠ¼ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
      }
    };

    // í¬ì¸íŠ¸ ë³€ê²½ ì‹œë§ˆë‹¤ ì „í™˜ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
    window.addEventListener('pointsUpdated', function() {
      window.updateExchangeButton();
    });
  </script>
  </script>
  <script src="script.js" onerror="console.error('script.js ë¡œë“œ ì‹¤íŒ¨')" onload="console.log('script.js ë¡œë“œ ì„±ê³µ')"></script>
</body>
</html>
